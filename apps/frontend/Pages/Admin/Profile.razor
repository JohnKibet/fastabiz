@page "/admin/profile"
@using System.Security.Claims
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

<PageTitle>User Profile</PageTitle>

<div class="max-w-3xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-2xl space-y-6">

    <!-- HEADER -->
    <div class="flex items-center space-x-4">
        <img src="https://ui-avatars.com/api/?name=@UserFullName&background=F97316&color=fff" 
             alt="User Avatar" 
             class="w-20 h-20 rounded-full shadow" />

        <div>
            <p class="text-xl font-semibold text-gray-800">@UserFullName</p>
            <div class="flex items-center space-x-2 mt-1">
                <span class="px-2 py-1 text-xs rounded-full text-white 
                    @(UserRole.ToLower() == "admin" ? "bg-red-500" :
                      UserRole.ToLower() == "driver" ? "bg-blue-500" :
                      UserRole.ToLower() == "customer" ? "bg-green-600" : "bg-gray-500")">
                    @UserRole
                </span>

                <span class="px-2 py-1 text-xs rounded-full text-white 
                    @(UserStatus.ToLower() == "active" ? "bg-green-500" :
                      UserStatus.ToLower() == "suspended" ? "bg-red-600" :
                      UserStatus.ToLower() == "pending" ? "bg-yellow-500" : "bg-gray-500")">
                    @UserStatus
                </span>
            </div>
        </div>
    </div>

    <!-- DETAILS CARD -->
    <div class="grid grid-cols-1 gap-4">

        <div class="p-4 border rounded-xl bg-gray-50">
            <p class="text-xs text-gray-500 uppercase">Email</p>
            <p class="text-gray-800 font-medium">@UserEmail</p>
        </div>

        <div class="p-4 border rounded-xl bg-gray-50">
            <p class="text-xs text-gray-500 uppercase">Phone</p>
            <p class="text-gray-800 font-medium">@UserPhone</p>
        </div>

        <div class="p-4 border rounded-xl bg-gray-50">
            <p class="text-xs text-gray-500 uppercase">Slug</p>
            <p class="text-gray-800 font-medium">@UserSlug</p>
        </div>

        <div class="p-4 border rounded-xl bg-gray-50">
            <p class="text-xs text-gray-500 uppercase">Last Login</p>
            <p class="text-gray-800 font-medium">
                @(LastLogin is not null ? LastLogin.Value.ToString("MMM d, yyyy h:mm tt") : "Never")
            </p>
        </div>

        <div class="p-4 border rounded-xl bg-gray-50">
            <p class="text-xs text-gray-500 uppercase">Joined</p>
            <p class="text-gray-800 font-medium">@CreatedAt.ToString("MMM d, yyyy")</p>
        </div>

    </div>

    <!-- ACTION BUTTONS -->
    <div class="flex flex-wrap gap-3 pt-3">

        <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow">
            Edit Profile
        </button>

        <button class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow">
            Manage Sessions
        </button>

        <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow">
            Change Password
        </button>

        <button class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg shadow"
                @onclick="@(() => Navigation.NavigateTo("/logout"))">
            Logout
        </button>
    </div>

</div>

@code {
    private string UserFullName { get; set; } = "Unknown User";
    private string UserEmail { get; set; } = "N/A";
    private string UserRole { get; set; } = "Guest";
    private string UserStatus { get; set; } = "active";
    private string UserPhone { get; set; } = "Not Provided";
    private string UserSlug { get; set; } = "n/a";
    private DateTime? LastLogin { get; set; }
    private DateTime CreatedAt { get; set; } = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            UserFullName = user.FindFirst(ClaimTypes.Name)?.Value ?? "Unknown";
            UserEmail = user.FindFirst(ClaimTypes.Email)?.Value ?? "Not Provided";
            UserRole = user.FindFirst(ClaimTypes.Role)?.Value ?? "guest";

            UserPhone = user.FindFirst("phone")?.Value ?? "Not Provided";
            UserSlug = user.FindFirst("slug")?.Value ?? "- -";
            UserStatus = user.FindFirst("status")?.Value ?? "active";

            var lastLoginStr = user.FindFirst("last_login")?.Value;
            if (DateTime.TryParse(lastLoginStr, out var parsed))
                LastLogin = parsed;

            var createdStr = user.FindFirst("created_at")?.Value;
            if (DateTime.TryParse(createdStr, out var created))
                CreatedAt = created;
        }
    }
}
