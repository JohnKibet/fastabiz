@page "/admin/settings"
@layout AdminLayout
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@inject UserService UserService
@inject ToastService ToastService

<PageTitle>Settings</PageTitle>

<div class="max-w-3xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-2xl space-y-8">

    <h2 class="text-2xl font-semibold font-poppins text-gray-800">Settings</h2>

    <section>
        <h3 class="text-lg font-medium text-gray-700 mb-4">Notifications</h3>

        <!-- Enable / Disable All Notifications -->
        <div class="flex items-center justify-between mb-4 p-3 border rounded-xl bg-gray-50">
            <label class="text-sm font-medium text-gray-600">Enable All Notifications</label>

            <button type="button"
                    class="relative inline-flex h-6 w-11 items-center rounded-full transition-all duration-300 
                           @(notificationsEnabled ? "bg-green-500" : "bg-gray-300")"
                    @onclick="ToggleNotifications">
                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-300
                              @(notificationsEnabled ? "translate-x-6" : "translate-x-1")">
                </span>
            </button>
        </div>

        <!-- Notification Types -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

            @foreach (var option in NotificationOptions)
            {
                <div class="flex items-center justify-between p-3 border rounded-xl bg-gray-50 shadow-sm">
                    <div>
                        <p class="font-medium text-gray-700">@option.Label</p>
                        <p class="text-xs text-gray-500">Type: @option.Type</p>
                    </div>

                    <button type="button"
                            class="relative inline-flex h-6 w-11 items-center rounded-full transition 
                                   @(option.Enabled ? "bg-green-500" : "bg-gray-300")"
                            @onclick="@(() => ToggleType(option))">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition
                                      @(option.Enabled ? "translate-x-6" : "translate-x-1")">
                        </span>
                    </button>
                </div>
            }
        </div>
    </section>

    <section>
        <h3 class="text-lg font-medium text-gray-700 mb-2">Security</h3>

        <button 
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md"
            @onclick="()=> ShowChangePasswordModal = true">
            Change Password
        </button>

        <ChangePassword 
            Show="@ShowChangePasswordModal"
            ShowChanged="@(v => ShowChangePasswordModal = v)"
            Model="@PasswordModel"
            OnSubmit="SubmitPasswordChange" />


    </section>

</div>

@code {
    [CascadingParameter] public Guid? UserId { get; set; }
    private bool ShowChangePasswordModal = false;
    private ChangePasswordModel PasswordModel = new(); 
    private async Task SubmitPasswordChange()
    {
        if (PasswordModel.NewPassword != PasswordModel.ConfirmPassword)
        {
            ToastService.ShowToast("New passwords do not match.", ToastService.ToastLevel.Error);
            return;
        }

        if (!UserId.HasValue)
        {
            ToastService.ShowToast("User not logged in or session expired.", ToastService.ToastLevel.Error);
            return;
        }

        var response = await UserService.ChangePassword(UserId.Value, PasswordModel.CurrentPassword, PasswordModel.NewPassword);

        if (response.Success)
        {
            PasswordModel = new();
            ShowChangePasswordModal = false;

            ToastService.ShowToast("Password updated.", ToastService.ToastLevel.Success);
            return;
        }
        
        var errMessage = response.Error;
        if (errMessage == null)
        {
            ToastService.ShowToast("Password update failed (unknown error)", ToastService.ToastLevel.Error);
            return;
        }
        if (!string.IsNullOrWhiteSpace(errMessage.Detail))
        {
            ToastService.ShowToast(errMessage.Detail, ToastService.ToastLevel.Error);
            return;
        }   

        ToastService.ShowToast("Password update failed", ToastService.ToastLevel.Error);
    }
    private bool notificationsEnabled = true;

    private List<NotificationSetting> NotificationOptions = new()
    {
        new NotificationSetting("Email Notifications", "email"),
        new NotificationSetting("SMS Alerts", "sms"),
        new NotificationSetting("Push Notifications", "push"),
        new NotificationSetting("System Alerts", "system"),
    };

    private void ToggleNotifications()
    {
        notificationsEnabled = !notificationsEnabled;

        // Enable/disable individual toggles based on master switch
        foreach (var opt in NotificationOptions)
        {
            opt.Enabled = notificationsEnabled;
        }

        // TODO: Persist preference
    }

    private void ToggleType(NotificationSetting setting)
    {
        setting.Enabled = !setting.Enabled;

        // If one is turned off, disable master
        if (!setting.Enabled)
            notificationsEnabled = false;

        // TODO: Save per-type preference (Push/SMS/Email/System)
    }

    private class NotificationSetting
    {
        public string Label { get; set; }
        public string Type { get; set; }
        public bool Enabled { get; set; } = true;

        public NotificationSetting(string label, string type)
        {
            Label = label;
            Type = type;
        }
    }
}
