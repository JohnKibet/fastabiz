@page "/checkout/{InvoiceId:guid}"

@using frontend.Models
@using frontend.Pages.Shared.Components
@using frontend.Pages.Shared.Components.OrderSummary
@using frontend.Pages.Shared.Components.PaymentMethods
@using frontend.Pages.Shared.Components.PaymentForm
@inject PaymentService PaymentService

<PageTitle>Checkout</PageTitle>

<div class="max-w-2xl mx-auto p-6 space-y-6 bg-white rounded-xl shadow-sm">
    @if (Invoice is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="divide-y divide-gray-200">
            <OrderSummary Invoice="Invoice" />
            <PaymentMethods 
                SelectedMethod="SelectedMethod" 
                OnMethodChanged="method => SelectedMethod = method" />
            <PaymentForm 
                Method="SelectedMethod" 
                OnSubmit="HandlePayment" 
                IsLoading="@IsProcessing" />
            <PaymentStatus Status="@PaymentResult" />
        </div>
    }
</div>

@code {
    [Parameter] public Guid InvoiceId { get; set; }

    private Invoice? Invoice;
    private string? SelectedMethod;
    private string? PaymentResult;
    private bool IsProcessing;

    protected override async Task OnInitializedAsync()
    {
        Invoice = await PaymentService.GetInvoiceAsync(InvoiceId);
    }

    private async Task HandlePayment()
    {
        IsProcessing = true;
        PaymentResult = await PaymentService.ProcessPaymentAsync(InvoiceId, SelectedMethod);
        IsProcessing = false;
    }
}