@page "/customer/checkout"
@layout CustomerLayout
@using frontend.Models
@using frontend.Pages.Shared.Components.Cart
@inject CartService CartService
@inject NavigationManager Navigation

<div class="p-6 max-w-5xl mx-auto">

    <h1 class="text-3xl font-bold mb-8">Checkout</h1>

    @if (!CartService.Items.Any())
    {
        <p class="text-gray-500 text-lg">
            Your cart is empty.
            <button class="text-stoneblue font-medium ml-2" @onclick="GoShop">Shop Now</button>
        </p>
    }
    else
    {
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Cart Section -->
            <div class="lg:w-1/2 bg-white shadow rounded-lg p-6">
                <h2 class="font-semibold text-xl mb-4">Your Cart</h2>
                <CartCard />
            </div>

            <!-- Delivery / Map Section -->
            <div class="flex flex-col gap-6">

                <!-- Top Buttons Row -->
                <div class="flex justify-between items-center mb-4">
                    <button class="px-4 py-2 rounded bg-stoneblue text-white text-sm" @onclick="UseUsualAddresses">
                        Use usual addresses
                    </button>

                    <button class="px-4 py-2 rounded bg-gray-300 text-gray-700 text-sm" @onclick="() => ShowMap = !ShowMap">
                        @(ShowMap ? "Hide Map" : "Show Map")
                    </button>
                </div>

                <!-- Delivery / Pickup Inputs -->
                <div class="flex flex-col gap-3">
                    <div class="flex items-center gap-2">
                        <button class="px-3 py-1 rounded text-white text-sm @DeliveryBtnClass"
                            @onclick="() => SetMode(CustomerMap.MapClickMode.Delivery)" disabled="@(!ShowMap)">
                            Delivery
                        </button>
                        <input type="text" class="border rounded px-2 py-1 flex-1" placeholder="Delivery address"
                            @bind="DeliveryAddress" disabled="@(!IsDeliveryMode || !ShowMap)" />
                    </div>

                    <div class="flex items-center gap-2">
                        <button class="px-3 py-1 rounded text-white text-sm @PickupBtnClass"
                            @onclick="() => SetMode(CustomerMap.MapClickMode.Pickup)" disabled="@(!ShowMap)">
                            Pickup
                        </button>
                        <input type="text" class="border rounded px-2 py-1 flex-1" placeholder="Pickup location"
                            @bind="PickupAddress" disabled="@(!IsPickupMode || !ShowMap)" />
                    </div>
                </div>

                @if (ShowMap)
                {
                    <div class="border rounded p-4 bg-gray-100 text-gray-600 text-center"
                        style="height:300px; display:flex; align-items:center; justify-content:center;">
                        Map would appear here
                    </div>
                }

                <!-- Centered Proceed Button -->
                <div class="flex justify-center mt-4">
                    <button class="px-6 py-2 bg-stoneblue text-white rounded shadow hover:bg-stoneblue/90 text-sm"
                        @onclick="GoToPayment">
                        Proceed to Payment
                    </button>
                </div>

            </div>

        </div>
    }
</div>

@code {
    private CustomerMap.MapClickMode mapClickMode = CustomerMap.MapClickMode.Delivery;
    private string DeliveryAddress { get; set; } = "";
    private string PickupAddress { get; set; } = "";

    private bool ShowMap { get; set; } = true;

    private CustomerAddress UsualAddresses { get; set; } = new()
    {
        Delivery = "Kenyatta Avenue, CBD, Nairobi",
        Pickup = "Accra Road, CBD, Nairobi"
    };

    private bool IsDeliveryMode => mapClickMode == CustomerMap.MapClickMode.Delivery;
    private bool IsPickupMode => mapClickMode == CustomerMap.MapClickMode.Pickup;

    private string DeliveryBtnClass => IsDeliveryMode ? "bg-blue-600 opacity-100" : "bg-blue-400 opacity-60 hover:opacity-90";
    private string PickupBtnClass => IsPickupMode ? "bg-green-600 opacity-100" : "bg-green-400 opacity-60 hover:opacity-90";

    private void SetMode(CustomerMap.MapClickMode mode) => mapClickMode = mode;

    private void UseUsualAddresses()
    {
        DeliveryAddress = UsualAddresses.Delivery;
        PickupAddress = UsualAddresses.Pickup;
        ShowMap = false;
    }

    private void GoShop() => Navigation.NavigateTo("/storefront");

    private void GoToPayment()
    {
        if (string.IsNullOrWhiteSpace(DeliveryAddress) && string.IsNullOrWhiteSpace(PickupAddress))
        {
            DeliveryAddress = UsualAddresses.Delivery;
            PickupAddress = UsualAddresses.Pickup;
        }

        // Using hardcoded coordinates for MVP
        var delLat = "-1.2848242046310998";
        var delLng = "36.82204128701168";
        var pickLat = "-1.2829256773845723";
        var pickLng = "36.827309307951396";

        // Serialize cart items to query param
        var cartJson = System.Text.Json.JsonSerializer.Serialize(CartService.Items);

        Navigation.NavigateTo(
        $"/customer/payment" +
        $"?delivery={Uri.EscapeDataString(DeliveryAddress)}" +
        $"&pickup={Uri.EscapeDataString(PickupAddress)}" +
        $"&delLat={delLat}&delLng={delLng}&pickLat={pickLat}&pickLng={pickLng}" +
        $"&cart={Uri.EscapeDataString(cartJson)}"
        );
    }

    public class CustomerAddress
    {
        public string Delivery { get; set; } = string.Empty;
        public string Pickup { get; set; } = string.Empty;
    }
}