@page "/customer/payment"
@layout CustomerLayout
@using frontend.Models
@using Microsoft.AspNetCore.WebUtilities
@using System.Text.Json
@inject CartService CartService
@inject OrderService OrderService
@inject ToastService ToastService
@inject PaymentService PaymentService
@inject NavigationManager Navigation

<h1 class="text-2xl font-bold mb-6">Payment</h1>

@if (CartItems == null || !CartItems.Any())
{
    <p class="text-gray-500">
        Your cart is empty.
        <button class="text-stoneblue font-medium" @onclick="GoShop">Shop Now</button>
    </p>
}
else
{
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Order Summary -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="font-semibold text-lg mb-4">Order Summary</h2>
            @foreach (var item in CartItems)
            {
                <div class="flex items-center justify-between py-3 border-b">
                    <div>
                        <p class="font-medium">@item.Name</p>
                        @if (!string.IsNullOrEmpty(item.VariantName))
                        {
                            <p class="text-gray-500 text-sm">@item.VariantName</p>
                        }
                        <p class="text-gray-500 text-sm">x @item.Quantity</p>
                    </div>
                    <p class="font-semibold">@((item.Price * item.Quantity).ToString("0.00"))</p>
                </div>
            }
            <div class="mt-4 flex justify-between font-bold text-lg border-t pt-2">
                <span>Total:</span>
                <span>@CartItems.Sum(i => i.Price * i.Quantity).ToString("0.00")</span>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="font-semibold text-lg mb-4">Payment Method</h2>

            <div class="space-y-4">

                <!-- Cash on Delivery -->
                <div class="border rounded-lg p-4 hover:border-orange-500 transition cursor-pointer"
                    @onclick='() => SelectedMethod = "cod"'>
                    <input type="radio" id="cod" name="payment" class="mr-2" checked="@((SelectedMethod == "cod"))" />
                    <label for="cod" class="font-medium text-gray-800">Cash on Delivery</label>
                    @if (SelectedMethod == "cod")
                    {
                        <p class="mt-2 text-gray-500 text-sm">You will pay the delivery person when you receive your order.</p>
                    }
                </div>

                <!-- MPesa Express -->
                <div class="border rounded-lg p-4 hover:border-orange-500 transition cursor-pointer"
                    @onclick='() => SelectedMethod = "mpesa-express"'>
                    <input type="radio" id="mpesa-express" name="payment" class="mr-2"
                        checked="@((SelectedMethod == "mpesa-express"))" />
                    <label for="mpesa-express" class="font-medium text-gray-800">
                        M-Pesa Express (Paybill)
                    </label>

                    @if (SelectedMethod == "mpesa-express")
                    {
                        <div class="mt-3 space-y-3">
                            <input type="text" placeholder="Phone Number (+2547...)" @bind="MpesaPhone"
                                class="w-full px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm" />
                            <input type="text" placeholder="Amount" @bind="MpesaAmount"
                                class="w-full px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm" />
                            <p class="text-gray-500 text-xs mt-1">
                                You will be prompted to enter your M-Pesa PIN to complete the payment.
                            </p>
                        </div>
                    }
                </div>

                <!-- Other methods can be added here -->
            </div>

            <button
                class="mt-6 w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-lg shadow-sm transition"
                @onclick="ConfirmPayment">
                Pay Now
            </button>

            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="mt-6 text-green-600 bg-green-50 border border-green-200 rounded-lg p-4 text-sm">
                    ✅ @SuccessMessage
                </div>
            }
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="mt-6 text-red-600 bg-red-50 border border-red-200 rounded-lg p-4 text-sm">
                    ⚠️ @ErrorMessage
                </div>
            }
        </div>
    </div>
}

@code {
    [CascadingParameter] public Guid? UserId { get; set; }

    private string SelectedMethod { get; set; } = "cod";
    private string? SuccessMessage { get; set; }
    private string? ErrorMessage { get; set; }

    private List<CartItem>? CartItems { get; set; }

    private string DeliveryAddress { get; set; } = "";
    private string PickupAddress { get; set; } = "";
    private double DeliveryLat { get; set; }
    private double DeliveryLng { get; set; }
    private double PickupLat { get; set; }
    private double PickupLng { get; set; }

    // MPesa Express fields
    private string MpesaPhone { get; set; } = "";
    private string MpesaAmount { get; set; } = "";

    protected override void OnInitialized()
    {
        if (!UserId.HasValue)
        {
            Navigation.NavigateTo("/auth/login");
            return;
        }

        CartItems = CartService.Items.ToList();

        // Parse query params for delivery/pickup
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        DeliveryAddress = query["delivery"].ToString() ?? "";
        PickupAddress = query["pickup"].ToString() ?? "";
        double.TryParse(query["delLat"], out var delLat);
        double.TryParse(query["delLng"], out var delLng);
        double.TryParse(query["pickLat"], out var pickLat);
        double.TryParse(query["pickLng"], out var pickLng);
        DeliveryLat = delLat;
        DeliveryLng = delLng;
        PickupLat = pickLat;
        PickupLng = pickLng;
    }

    private void GoShop() => Navigation.NavigateTo("/storefront");

    private async Task ConfirmPayment()
    {
        if (CartItems == null || !CartItems.Any())
        {
            ErrorMessage = "Your cart is empty.";
            return;
        }

        var items = CartItems.Select(i => new CreateOrderItemDto
        {
            ProductId = i.ProductId,
            VariantId = i.VariantId == Guid.Empty ? null : i.VariantId,
            Quantity = i.Quantity
        }).ToList();

        var request = new CreateOrderRequest
        {
            StoreId = CartItems.First().StoreId,
            CustomerId = UserId!.Value,
            PaymentMethod = SelectedMethod,
            Delivery = new LocationDto
            {
                Address = DeliveryAddress,
                Lat = DeliveryLat,
                Lng = DeliveryLng
            },
            Pickup = new LocationDto
            {
                Address = PickupAddress,
                Lat = PickupLat,
                Lng = PickupLng
            },
            Items = items
        };

        if (SelectedMethod == "mpesa-express")
        {
            if (string.IsNullOrWhiteSpace(MpesaPhone) || string.IsNullOrWhiteSpace(MpesaAmount))
            {
                ErrorMessage = "Phone number and amount are required.";
                return;
            }

            var res = await PaymentService.StartMpesaExpressAsync(MpesaPhone, MpesaAmount);

            if (!res.Success)
            {
                ToastService.ShowToast(
                "Failed to initiate MPesa payment.",
                "",
                ToastService.ToastLevel.Error
                );
                return;
            }

            SuccessMessage = res.Data?.CustomerMessage ??
            "MPesa prompt sent. Please check your phone.";
            ToastService.ShowToast(
            SuccessMessage,
            "",
            ToastService.ToastLevel.Success
            );
        }

        var result = await OrderService.AddOrder(request);

        if (result.Success)
        {
            SuccessMessage = "Order created successfully!";
            ToastService.ShowToast(SuccessMessage, string.Empty, ToastService.ToastLevel.Success);
            CartService.ClearCart();
            return;
        }

        ErrorMessage = result.Error?.Detail ?? "Failed to create order.";
        ToastService.ShowToast(ErrorMessage, string.Empty, ToastService.ToastLevel.Error);
    }
}