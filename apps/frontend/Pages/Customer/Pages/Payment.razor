@* @page "/customer/payment"
@layout CustomerLayout
@using frontend.Models
@inject CartService CartService
@inject NavigationManager Navigation

<div class="max-w-3xl mx-auto">
    <!-- Page Heading -->
    <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
        üí≥ Complete Your Payment
    </h2>

    <!-- Order Summary -->
    <div class="bg-white shadow-sm rounded-xl border p-6 mb-6">
        <h3 class="text-lg font-medium text-gray-800 mb-4">Order Summary</h3>
        <div class="space-y-2 text-sm text-gray-700">
            @foreach (var item in CartService.Items)
            {
                <div class="flex justify-between">
                    <div>
                        <p class="font-medium">@item.Name</p>
                        @if (!string.IsNullOrEmpty(item.VariantName))
                        {
                            <p class="text-gray-500 text-sm">@item.VariantName</p>
                        }
                        <p class="text-gray-500 text-sm">x @item.Quantity</p>
                    </div>
                    <p class="font-semibold">@((item.Price) * item.Quantity)</p>
                </div>
            }
        </div>
        <div class="mt-4 flex justify-between font-bold text-lg border-t pt-2">
            <span>Total:</span>
            <span>@CartService.Items.Sum(i => i.Price * i.Quantity):C</span>
        </div>
    </div>

    <!-- Payment Options -->
    <div class="bg-white shadow-sm rounded-xl border p-6">
        <h3 class="text-lg font-medium text-gray-800 mb-4">Payment Method</h3>

        <div class="space-y-4">
            <!-- Card Payment -->
            <div class="border rounded-lg p-4 hover:border-orange-500 transition cursor-pointer">
                <input type="radio" id="card" name="payment" class="mr-2" @bind:event="SelectedMethod" Value="card" />
                <label for="card" class="font-medium text-gray-800">Credit / Debit Card</label>
                @if (SelectedMethod == "card")
                {
                    <div class="mt-3 space-y-3">
                        <input
                            type="text"
                            placeholder="Card Number"
                            class="w-full px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                        />
                        <div class="flex gap-3">
                            <input
                                type="text"
                                placeholder="MM/YY"
                                class="w-1/3 px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                            />
                            <input
                                type="text"
                                placeholder="CVC"
                                class="w-1/3 px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                            />
                        </div>
                    </div>
                }
            </div>

            <!-- Mobile Money -->
            <div class="border rounded-lg p-4 hover:border-orange-500 transition cursor-pointer">
                <input type="radio" id="mpesa" name="payment" class="mr-2" @bind:event="SelectedMethod" value="mpesa" />
                <label for="mpesa" class="font-medium text-gray-800">Mobile Money (M-Pesa, Airtel Money)</label>
                @if (SelectedMethod == "mpesa")
                {
                    <div class="mt-3">
                        <input
                            type="text"
                            placeholder="Phone Number"
                            class="w-full px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                        />
                    </div>
                }
            </div>
        </div>

        <!-- Pay Button -->
        <button
            class="mt-6 w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-lg shadow-sm transition"
            @onclick="ConfirmPayment">
            Pay Now
        </button>

        <!-- Confirmation Messages -->
        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="mt-6 text-green-600 bg-green-50 border border-green-200 rounded-lg p-4 text-sm">
                ‚úÖ @SuccessMessage
            </div>
        }
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="mt-6 text-red-600 bg-red-50 border border-red-200 rounded-lg p-4 text-sm">
                ‚ö†Ô∏è @ErrorMessage
            </div>
        }
    </div>
</div>

@code {
    private string SelectedMethod { get; set; } = "card";
    private string? SuccessMessage { get; set; }
    private string? ErrorMessage { get; set; }

    private async Task ConfirmPayment()
    {
        if (string.IsNullOrWhiteSpace(SelectedMethod))
        {
            ErrorMessage = "Please select a payment method.";
            SuccessMessage = null;
            return;
        }

        try
        {
            // TODO: Integrate with backend payment service
            SuccessMessage = "Payment successful! üéâ";
            ErrorMessage = null;

            // Optionally navigate to confirmation page
            Navigation.NavigateTo("/orders/confirmation");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Payment failed: {ex.Message}";
            SuccessMessage = null;
        }
    }
} *@

@page "/customer/payment"
@layout CustomerLayout
@using frontend.Models
@using Microsoft.AspNetCore.WebUtilities
@inject CartService CartService
@inject OrderService OrderService
@inject ToastService ToastService
@inject NavigationManager Navigation

<h1 class="text-2xl font-bold mb-6">Payment</h1>

@if (!CartService.Items.Any())
{
    <p class="text-gray-500">
        Your cart is empty. 
        <button class="text-stoneblue font-medium" @onclick="GoShop">Shop Now</button>
    </p>
}
else
{
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Order Summary -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="font-semibold text-lg mb-4">Order Summary</h2>
            @foreach (var item in CartService.Items)
            {
                <div class="flex items-center justify-between py-3 border-b">
                    <div>
                        <p class="font-medium">@item.Name</p>
                        @if (!string.IsNullOrEmpty(item.VariantName))
                        {
                            <p class="text-gray-500 text-sm">@item.VariantName</p>
                        }
                        <p class="text-gray-500 text-sm">x @item.Quantity</p>
                    </div>
                    <p class="font-semibold">@((item.Price) * item.Quantity)</p>
                </div>
            }
            <div class="mt-4 flex justify-between font-bold text-lg border-t pt-2">
                <span>Total:</span>
                <span>@CartService.Items.Sum(i => i.Price * i.Quantity)</span>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="font-semibold text-lg mb-4">Payment Method</h2>

            <div class="space-y-4">
                <!-- Card Payment -->
                <div class="border rounded-lg p-4 hover:border-orange-500 transition cursor-pointer">
                    <input type="radio" id="card" name="payment" class="mr-2" 
                           @bind:event="SelectedMethod" Value="card" />
                    <label for="card" class="font-medium text-gray-800">Credit / Debit Card</label>
                    @if (SelectedMethod == "card")
                    {
                        <div class="mt-3 space-y-3">
                            <input
                                type="text"
                                placeholder="Card Number"
                                class="w-full px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                            />
                            <div class="flex gap-3">
                                <input
                                    type="text"
                                    placeholder="MM/YY"
                                    class="w-1/3 px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                                />
                                <input
                                    type="text"
                                    placeholder="CVC"
                                    class="w-1/3 px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                                />
                            </div>
                        </div>
                    }
                </div>

                <!-- Mobile Money -->
                <div class="border rounded-lg p-4 hover:border-orange-500 transition cursor-pointer">
                    <input type="radio" id="mpesa" name="payment" class="mr-2" 
                           @bind:event="SelectedMethod" Value="mpesa" />
                    <label for="mpesa" class="font-medium text-gray-800">Mobile Money (M-Pesa, Airtel Money)</label>
                    @if (SelectedMethod == "mpesa")
                    {
                        <div class="mt-3">
                            <input
                                type="text"
                                placeholder="Phone Number"
                                class="w-full px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:outline-none text-sm"
                            />
                        </div>
                    }
                </div>

                <!-- Cash on Delivery -->
                <div class="border rounded-lg p-4 hover:border-orange-500 transition cursor-pointer">
                    <input type="radio" id="cod" name="payment" class="mr-2" 
                        @bind:event="SelectedMethod" Value="cod" />
                    <label for="cod" class="font-medium text-gray-800">Cash on Delivery</label>
                    @if (SelectedMethod == "cod")
                    {
                        <p class="mt-2 text-gray-500 text-sm">You will pay the delivery person when you receive your order.</p>
                    }
                </div>
            </div>

            <button
                class="mt-6 w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-lg shadow-sm transition"
                @onclick="ConfirmPayment">
                Pay Now
            </button>

            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="mt-6 text-green-600 bg-green-50 border border-green-200 rounded-lg p-4 text-sm">
                    ‚úÖ @SuccessMessage
                </div>
            }
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="mt-6 text-red-600 bg-red-50 border border-red-200 rounded-lg p-4 text-sm">
                    ‚ö†Ô∏è @ErrorMessage
                </div>
            }
        </div>
    </div>
}

@code {
    [CascadingParameter] public Guid? UserId { get; set; }
    private string SelectedMethod { get; set; } = "cod";
    private string? SuccessMessage { get; set; }
    private string? ErrorMessage { get; set; }
    private Guid? CustomerID { get; set; }

    private void GoShop() => Navigation.NavigateTo("/storefront");

    protected override Task OnInitializedAsync()
    {
        if (!UserId.HasValue)
        {
            Navigation.NavigateTo("/auth/login");
            return Task.CompletedTask;
        }

        return Task.CompletedTask;
    }

    private async Task ConfirmPayment()
    {
       // simulate fetching location from URL until we do service-based map
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        string delAddress = query["delivery"].ToString() ?? "";
        string pickAddress = query["pickup"].ToString() ?? "";
        double.TryParse(query["delLat"], out var delLat);
        double.TryParse(query["delLng"], out var delLng);
        double.TryParse(query["pickLat"], out var pickLat);
        double.TryParse(query["pickLng"], out var pickLng);

        var storeId = CartService.Items.First().StoreId;
        if (storeId == Guid.Empty)
        {
            ErrorMessage = "Invalid store reference in cart.";
            return;
        }

        var items = new List<CreateOrderItemDto>();

        foreach (var i in CartService.Items)
        {
            var productId = i.ProductId;
            if (productId == Guid.Empty)
            {
                ErrorMessage = "Invalid product reference in cart.";
                return;
            }

            Guid? variantId = i.VariantId == Guid.Empty
            ? null
            : i.VariantId;

            items.Add(new CreateOrderItemDto
            {
                ProductId = productId,
                VariantId = variantId,
                Quantity = i.Quantity
            });
        }

        var request = new CreateOrderRequest
        {
            StoreId = storeId,
            CustomerId = UserId!.Value,
            PaymentMethod = SelectedMethod,

            Delivery = new LocationDto
            {
                Address = delAddress,
                Lat = delLat,
                Lng = delLng
            },

            Pickup = new LocationDto
            {
                Address = pickAddress,
                Lat = pickLat,
                Lng = pickLng
            },

            Items = items
        };

        var result = await OrderService.AddOrder(request);
        Console.WriteLine($"ORDER TEST OBJECT: {System.Text.Json.JsonSerializer.Serialize(request)}");
        if (result.Success)
        {
            ToastService.ShowToast("Order created successfully!", string.Empty, ToastService.ToastLevel.Success);
            @* Navigation.NavigateTo("admin/users"); *@
            return;
        }

        var errMessage = result.Error;

        if (errMessage == null)
        {
            ToastService.ShowToast("Failed to create order (unknown error)", string.Empty, ToastService.ToastLevel.Error);
            return;
        }

        if (!string.IsNullOrWhiteSpace(errMessage.Detail))
        {
            ToastService.ShowToast(errMessage.Detail, string.Empty, ToastService.ToastLevel.Error);
            return;
        }

        ToastService.ShowToast("Failed to create order.", string.Empty, ToastService.ToastLevel.Error);

        @* Navigation.NavigateTo("/orders/confirmation"); *@
    }
}
