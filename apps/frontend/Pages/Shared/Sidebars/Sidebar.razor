@using System.Security.Claims
@using Microsoft.AspNetCore.WebUtilities
@using frontend.Models
@using frontend.Pages.Shared.Components.Icons
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

<div class="flex flex-col min-h-screen bg-white border-r border-gray-200 shadow-sm
            transition-all duration-300 ease-in-out @(IsCollapsed ? "w-16" : "w-64")">

    <!-- Header -->
    <div class="flex items-center justify-between px-3 py-3 border-b bg-gray-50">
        @if (!IsCollapsed)
        {
            <div class="flex items-center justify-center text-xl font-semibold font-poppins text-gray-800">
                FastaBiz
            </div>
        }

        <button class="p-1 rounded hover:bg-gray-100" @onclick="ToggleSidebar" aria-label="Toggle sidebar">
            <LucideIcon Name="@(IsCollapsed ? "chevrons-right" : "chevrons-left")" Size="7" />
        </button>
    </div>

    <!-- Menu -->
    <nav class="flex-1 overflow-y-auto mt-3 px-1 space-y-3">
        @if (Role == "merchant")
        {
            <SidebarSection Title="Dashboard" Icon="dashboard" SectionKey="MerchantDashboard" IsCollapsed="IsCollapsed"
                Items="MerchantDashboard" IsOpen="@IsSectionOpen(nameof(MerchantDashboard))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Operations" Icon="shuffle" SectionKey="MerchantOperations" IsCollapsed="IsCollapsed"
                Items="MerchantOperations" IsOpen="@IsSectionOpen(nameof(MerchantOperations))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Stores" Icon="warehouse" SectionKey="MerchantStores" IsCollapsed="IsCollapsed"
                Items="MerchantStores" IsOpen="@IsSectionOpen(nameof(MerchantStores))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Products" Icon="todo" SectionKey="MerchantProducts" IsCollapsed="IsCollapsed"
                Items="MerchantProducts" IsOpen="@IsSectionOpen(nameof(MerchantProducts))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Reports" Icon="chart" SectionKey="MerchantReports" IsCollapsed="IsCollapsed"
                Items="MerchantReports" IsOpen="@IsSectionOpen(nameof(MerchantReports))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Users" Icon="users" SectionKey="MerchantUsers" IsCollapsed="IsCollapsed"
                Items="MerchantUsers" IsOpen="@IsSectionOpen(nameof(MerchantUsers))" OnToggle="@ToggleSection" />
        }
        else if (Role == "driver")
        {
            <SidebarSection Title="Dashboard" Icon="layout-dashboard" SectionKey="DriverDashboard" IsCollapsed="IsCollapsed"
                Items="DriverDashboardItems" IsOpen="@IsSectionOpen(nameof(DriverDashboardItems))"
                OnToggle="@ToggleSection" />

            <SidebarSection Title="Deliveries" Icon="package" SectionKey="DriverDeliveries" IsCollapsed="IsCollapsed"
                Items="DriverDeliveriesItems" IsOpen="@IsSectionOpen(nameof(DriverDeliveriesItems))"
                OnToggle="@ToggleSection" />

            <SidebarSection Title="Navigation" Icon="route" SectionKey="DriverRoute" IsCollapsed="IsCollapsed"
                Items="DriverRouteItems" IsOpen="@IsSectionOpen(nameof(DriverRouteItems))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Proof of Delivery" Icon="package-check" SectionKey="DriverProof"
                IsCollapsed="IsCollapsed" Items="DriverProofItems" IsOpen="@IsSectionOpen(nameof(DriverProofItems))"
                OnToggle="@ToggleSection" />
        }

        else if (Role == "customer")
        {
            <SidebarSection Title="Dashboard" Icon="shopping-bag" SectionKey="CustomerMenu" IsCollapsed="IsCollapsed"
                Items="CustomerDashboard" IsOpen="@IsSectionOpen(nameof(CustomerDashboard))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Orders" Icon="todo" SectionKey="CustomerOrders" IsCollapsed="IsCollapsed"
                Items="CustomerOrders" IsOpen="@IsSectionOpen(nameof(CustomerOrders))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Checkout" Icon="" SectionKey="CustomerCheckout" IsCollapsed="IsCollapsed"
                Items="CustomerCheckout" IsOpen="@IsSectionOpen(nameof(CustomerCheckout))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Payment" Icon="" SectionKey="CustomerPayment" IsCollapsed="IsCollapsed"
                Items="CustomerPayment" IsOpen="@IsSectionOpen(nameof(CustomerPayment))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Feedback" Icon="shopping-bag" SectionKey="CustomerFeedback" IsCollapsed="IsCollapsed"
                Items="CustomerFeedback" IsOpen="@IsSectionOpen(nameof(CustomerFeedback))" OnToggle="@ToggleSection" />

            <SidebarSection Title="Track Order" Icon="" SectionKey="CustomerTrackOrder" IsCollapsed="IsCollapsed"
                Items="CustomerTrackOrder" IsOpen="@IsSectionOpen(nameof(CustomerTrackOrder))" OnToggle="@ToggleSection" />
        }
        else
        {
            <p class="text-sm text-gray-500 px-4">No menu available for your role.</p>
        }
    </nav>

    <!-- Footer -->
    <div class="border-t bg-gray-50 px-3 py-3 text-xs text-gray-500">
        @if (!IsCollapsed)
        {
            <div class="flex items-center justify-between">
                <span>Â© 2025 Logistics Platform</span>
            </div>
        }
        else
        {
            <div class="flex justify-center">
                <i class="lucide copyright w-4 h-4"></i>
            </div>
        }
    </div>
</div>

@code {
    [CascadingParameter] public ActiveProductContext ProductCtx { get; set; } = default!;
    private bool IsCollapsed = false;
    private string? Role;
    // keep track of open sections by a stable key (use nameof of the property)
    private HashSet<string> openSections = new();

    [Parameter] public EventCallback<bool> OnCollapseChanged { get; set; }

    private Guid? CurrentProductId;
    private string? CurrentPath;
    private string? CurrentMode;

    private bool IsManageProductActive =>
    CurrentProductId.HasValue &&
    CurrentPath?.StartsWith("/merchant/products/", StringComparison.OrdinalIgnoreCase) == true &&
    CurrentMode == "edit"; // only active if ?mode=edit


    protected override async Task OnInitializedAsync()
    {
        var state = await AuthProvider.GetAuthenticationStateAsync();
        Role = state.User.FindFirst(ClaimTypes.Role)?.Value ?? "guest";
        Navigation.LocationChanged += HandleLocationChanged;
        UpdateRouteState();
    }
    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateRouteState();
        StateHasChanged();
    }
    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }

    private void ToggleSidebar()
    {
        IsCollapsed = !IsCollapsed;
        // when collapsing, close all open sections overlay to keep UI tidy
        if (IsCollapsed) openSections.Clear();
        OnCollapseChanged.InvokeAsync(IsCollapsed);
    }

    private void ToggleSection(string sectionKey)
    {
        if (openSections.Contains(sectionKey))
            openSections.Remove(sectionKey);
        else
            openSections.Add(sectionKey);
        StateHasChanged();
    }

    private void UpdateRouteState()
    {
        var uri = new Uri(Navigation.Uri);
        CurrentPath = uri.AbsolutePath;

        // Parse product ID from path
        var segments = uri.AbsolutePath
        .Trim('/')
        .Split('/', StringSplitOptions.RemoveEmptyEntries);

        if (segments.Length == 3 &&
        segments[0] == "merchant" &&
        segments[1] == "products" &&
        Guid.TryParse(segments[2], out var id))
        {
            CurrentProductId = id;
        }
        else
        {
            CurrentProductId = null;
        }

        // Optional: parse mode from query string
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("mode", out var modeValue))
        {
            CurrentMode = modeValue.ToString(); // e.g. "edit"
        }
        else
        {
            CurrentMode = null;
        }
    }


    private bool IsSectionOpen(string sectionKey) => openSections.Contains(sectionKey);

    #region menu definitions
    private List<SidebarMenuItem> MerchantDashboard => new()
{
new("Dashboard", "/merchant/dashboard", "house"),
};
    private List<SidebarMenuItem> MerchantOperations => new()
{
new("Orders", "/merchant/orders", "file-stack"),
new("Order Assignments", "/merchant/operations/assignments", "truck"),

};

    private List<SidebarMenuItem> MerchantUsers => new()
{
new("Users", "/merchant/users", "users"),
new("Create User", "/merchant/createuser", "user-plus")
};

    private List<SidebarMenuItem> MerchantStores => new()
{
new("Create Store", "/merchant/stores/create", "create-store"),
new("All Stores", "/merchant/stores", "warehouse"),
new("Map", "/merchant/map", "map")
};

    private List<SidebarMenuItem> MerchantProducts => new()
{
new("Add Product", "/merchant/products/create", "layers-plus"),
new(
"Manage Product",
ProductCtx.HasValue
? $"/merchant/products/{ProductCtx.ProductId}?mode=edit"
: "/merchant/products?intent=manage",
"wrench",
active: IsManageProductActive
),
new("All Products", "/merchant/products", "layers")
};

    private List<SidebarMenuItem> MerchantReports => new()
{
new("Reports", "/merchant/reports", "chart-up"),
new("Invoices", "/merchant/invoices", "")
};

    private List<SidebarMenuItem> DriverDashboardItems => new() { new("Overview", "/driver/dashboard", "layout-panel-top")
};
    private List<SidebarMenuItem> DriverDeliveriesItems => new() { new("My Tasks", "/driver/deliveries", "truck") };
    private List<SidebarMenuItem> DriverRouteItems => new() { new("View Map", "/driver/route", "map") };
    private List<SidebarMenuItem> DriverProofItems => new() { new("Confirm Delivery", "/driver/proof", "package-check") };

    private List<SidebarMenuItem> CustomerDashboard => new()
{
new("Dashboard", "/customer/dashboard", "dashboard"),
};
    private List<SidebarMenuItem> CustomerTrackOrder => new()
{
new("Track Order", "/customer/trackorder", "map"),
};
    private List<SidebarMenuItem> CustomerOrders => new()
{
new("My Orders", "/customer/myorders", "package"),
};

    private List<SidebarMenuItem> CustomerFeedback => new()
{
new("Rate Delivery", "/customer/feedback", "thumbs-up"),
};

    private List<SidebarMenuItem> CustomerPayment => new()
{
new("Payment", "/customer/payment", "credit-card")
};

    private List<SidebarMenuItem> CustomerCheckout => new()
{
new("Checkout", "/customer/checkout", "cart")
};

    #endregion
}