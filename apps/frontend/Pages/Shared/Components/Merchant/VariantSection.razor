@using frontend.Models
@using frontend.Pages.Shared.Components.Merchant.Variants
@inject ProductService ProductService
@inject ToastService ToastService

<div class="mt-6 border-t pt-4">
  <h2 class="text-lg font-semibold text-textDark mb-2">Product Variants</h2>

  <div class="@(variantsCreated ? "opacity-60 pointer-events-none" : "")">
    <!-- Add Option Names -->
    <fieldset disabled="@(options.Any(o => o.IsNameLocked))" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-textDark">Option Name</label>
        <InputText @bind-Value="optionName" class="w-full mt-1 px-4 py-2 border rounded-lg" />
      </div>
      <div class="flex items-end">
        <button @onclick="AddOptionName" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-ctaHover">Add
          Option</button>
      </div>
    </fieldset>

    <!-- List of Option Names -->
    <OptionList Options="options" OnDeleteOption="@(opt => DeleteOption(opt))"
      OnAddOptionValues="@(opt => AddOptionValues(opt))" OnClearValues="@(opt => ClearValues(opt))" />


    @if (options.Any(o => o.IsNameLocked && o.AreValuesLocked) && !variantDrafts.Any())
    {
      BuildVariantDrafts();
    }
    @if (variantDrafts.Any())
    {
      <VariantDrafts Drafts="variantDrafts"
        OnImagesSelected="@(args => OnVariantImagesSelected(args.Item1, args.Item2))" />


      <div class="mt-6 flex justify-end">
        <button class="bg-primary text-white px-6 py-2 rounded-lg
                                                  disabled:opacity-50 disabled:cursor-not-allowed
                                                  hover:bg-ctaHover" @onclick="CreateVariants"
          disabled="@variantDrafts.Any(v => string.IsNullOrWhiteSpace(v.SKU) || v.Price <= 0)">
          Create Variants
        </button>
      </div>
    }

  </div>
  @if (createdVariants.Any())
  {
    <CreatedVariants Variants="createdVariants" OnResetAll="ResetAll" />
  }

</div>

@code {
  [Parameter] public Guid ProductId { get; set; }
  private string optionName = string.Empty;
  public class OptionUi
  {
    public Guid Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public bool IsNameLocked { get; set; }
    public string PendingValues { get; set; } = string.Empty;
    public List<string> Values { get; set; } = new();
    public bool AreValuesLocked { get; set; }
  }
  private List<OptionUi> options = new();

  public class VariantDraft
  {
    public string SKU { get; set; } = string.Empty;
    public double Price { get; set; }
    public int Stock { get; set; }
    public List<IBrowserFile> Files { get; set; } = new();
    public int PrimaryImageIndex { get; set; } = 0;
    public Dictionary<string, string> Options { get; set; } = new();
  }
  public List<VariantDraft> variantDrafts = new();
  private List<CreateVariantResponse> createdVariants = new();
  private bool variantsCreated => createdVariants.Any();

  private async Task AddOptionName()
  {
    if (string.IsNullOrWhiteSpace(optionName))
    {
      ToastService.ShowToast("Option name cannot be empty", string.Empty, ToastService.ToastLevel.Warning);
      return;
    }

    var req = new CreateOptionNameRequest
    {
      ProductId = ProductId,
      Name = optionName
    };

    var result = await ProductService.CreateOptionName(req);
    if (!result.Success || result.Data is null)
    {
      ToastService.ShowToast(
      result.Error?.Detail ?? "Failed to add option",
      string.Empty,
      ToastService.ToastLevel.Error
      );
      return;
    }

    options.Add(new OptionUi
    {
      Id = result.Data.OptionId,
      Name = optionName,
      IsNameLocked = true
    });

    optionName = string.Empty;
  }

  private void DeleteOption(OptionUi opt)
  {
    options.Remove(opt);
  }


  private async Task AddOptionValues(OptionUi opt)
  {
    if (string.IsNullOrWhiteSpace(opt.PendingValues))
    {
      ToastService.ShowToast("Enter values for the option", string.Empty, ToastService.ToastLevel.Warning);
      return;
    }

    var values = opt.PendingValues
    .Split(',')
    .Select(v => v.Trim())
    .Where(v => !string.IsNullOrWhiteSpace(v))
    .ToList();

    if (values.Count == 0)
      return;

    var req = new AddOptionValuesRequest
    {
      ProductId = ProductId,
      OptionId = opt.Id,
      Values = values
    };

    var result = await ProductService.AddOptionValues(req);
    if (result.Success)
    {
      opt.Values = values;
      opt.PendingValues = string.Empty;
      opt.AreValuesLocked = true;

      ToastService.ShowToast($"Values added to {opt.Name}", string.Empty, ToastService.ToastLevel.Success);
      opt.PendingValues = string.Empty;
    }
    else
    {
      ToastService.ShowToast(result.Error?.Detail ?? "Failed to add values", string.Empty, ToastService.ToastLevel.Error);
    }
  }
  private void OnVariantImagesSelected(InputFileChangeEventArgs e, VariantDraft draft)
  {
    draft.Files = e.GetMultipleFiles().ToList();
  }

  private void ClearValues(OptionUi opt)
  {
    opt.Values.Clear();
    opt.AreValuesLocked = false;
  }

  private void BuildVariantDrafts()
  {
    variantDrafts.Clear();

    var opt = options.Single(); // single-option MVP
    var index = 1;
    foreach (var value in opt.Values)
    {
      variantDrafts.Add(new VariantDraft
      {
        SKU = $"APP-{value.ToUpper()}-{index:D3}",
        Options = new Dictionary<string, string>
{
{ opt.Name, value }
}
      });

      index++;
    }
  }

  private async Task CreateVariants()
  {
    foreach (var draft in variantDrafts)
    {
      var req = new CreateVariantRequest
      {
        ProductId = ProductId,
        SKU = draft.SKU,
        Price = draft.Price,
        Stock = draft.Stock,
        Options = draft.Options
      };

      var result = await ProductService.CreateVariant(req);
      if (!result.Success || result.Data is null)
      {
        ToastService.ShowToast(
        result.Error?.Detail ?? "Failed to create variant",
        string.Empty,
        ToastService.ToastLevel.Error
        );
        return;
      }

      createdVariants.Add(result.Data);

      // upload images after variant exists
      await SaveVariantImages(result.Data.ProductId, draft);
    }

    ToastService.ShowToast(
    "Variants created successfully",
    "Your product variants are now live and ready for sale.",
    ToastService.ToastLevel.Success
    );
  }

  private async Task SaveVariantImages(Guid productId, VariantDraft draft)
  {
    if (!draft.Files.Any())
      return;

    var sig = await ProductService.GetCloudinarySignature();
    if (!sig.Success)
      return;

    var images = new List<Image>();

    for (int i = 0; i < draft.Files.Count; i++)
    {
      var url = await ProductService.UploadToCloudinary(
      draft.Files[i],
      sig.Data!
      );

      if (url is null)
        continue;

      images.Add(new Image
      {
        URL = url,
        IsPrimary = i == draft.PrimaryImageIndex
      });
    }

    if (!images.Any())
      return;

    await ProductService.AddProductImages(new AddImageRequest
    {
      ProductId = productId,
      Images = images
    });
  }

  private void ResetAll()
  {
    options.Clear();
    variantDrafts.Clear();
    createdVariants.Clear();
  }
}