@using frontend.Models
@inject ProductService ProductService
@inject ToastService ToastService

<div class="mt-6 border-t pt-4">
  <h2 class="text-lg font-semibold text-textDark mb-2">Product Variants</h2>

  <!-- Add Option Names -->
  <fieldset disabled="@(options.Any(o => o.IsNameLocked))" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium text-textDark">Option Name</label>
      <InputText @bind-Value="optionName" class="w-full mt-1 px-4 py-2 border rounded-lg" />
    </div>
    <div class="flex items-end">
      <button @onclick="AddOptionName" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-ctaHover">Add
        Option</button>
    </div>
  </fieldset>

  <!-- List of Option Names -->
  <ul class="mt-2">
    @foreach (var opt in options)
    {
      <div class="mt-4 border p-3 rounded-lg">
        <h3 class="text-sm font-medium text-textDark">@opt.Name</h3>

        @if (opt.IsNameLocked)
        {
          <button class="text-sm text-red-600 hover:underline" @onclick="() => DeleteOption(opt)">
            Delete
          </button>
        }

        <div class="flex space-x-2 mt-2">
          <InputText @bind-Value="opt.PendingValues" aria-disabled="@opt.AreValuesLocked"
            class="w-full px-3 py-1 border rounded-lg" placeholder="Comma separated values" />

          <button disabled="@opt.AreValuesLocked" @onclick="() => AddOptionValues(opt)"
            class="bg-primary text-white px-3 py-1 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
            Add Values
          </button>
        </div>
        @if (opt.Values.Any())
        {
          <div class="flex flex-wrap gap-2 mt-3">
            @foreach (var val in opt.Values)
            {
              <span class="px-3 py-1 text-sm bg-gray-100 rounded-full">
                @val
              </span>
            }
          </div>
        }
        @if (opt.AreValuesLocked)
        {
          <button class="text-xs text-red-600 mt-2 hover:underline" @onclick="() => ClearValues(opt)">
            Delete values
          </button>
        }
      </div>
    }
  </ul>
  @if (options.Any(o => o.IsNameLocked && o.AreValuesLocked) && !variantDrafts.Any())
  {
    BuildVariantDrafts();
  }
  @if (variantDrafts.Any())
  {
    <div class="mt-8">
      <h3 class="text-md font-semibold text-textDark mb-3">
        Variants
      </h3>

      <div class="space-y-4">
        @foreach (var v in variantDrafts)
        {
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end border p-3 rounded-lg">

            <div class="text-sm font-medium">
              @v.Options.First().Key: @v.Options.First().Value
            </div>

            <div class="flex flex-col">
              <label class="text-xs text-gray-600 mb-1">SKU</label>
              <InputText @bind-Value="v.SKU" placeholder="e.g. APP-SM-001" class="px-3 py-2 border rounded-lg" />
              <span class="text-[11px] text-gray-400 mt-1">
                Format: PRODUCT-OPTION-INDEX (APP-SM-001)
              </span>
            </div>

            <div class="flex flex-col">
              <label class="text-xs text-gray-600 mb-1">Price</label>
              <InputNumber @bind-Value="v.Price" class="px-3 py-2 border rounded-lg" />
            </div>

            <div class="flex flex-col">
              <label class="text-xs text-gray-600 mb-1">Stock</label>
              <InputNumber @bind-Value="v.Stock" class="px-3 py-2 border rounded-lg" />
            </div>

            <div class="flex flex-col">
              <label class="text-xs text-gray-600 mb-1">Image URL</label>
              <InputText @bind-Value="v.Image" class="px-3 py-2 border rounded-lg" />
            </div>
          </div>
        }
      </div>
    </div>

    <div class="mt-6 flex justify-end">
      <button disabled="@variantDrafts.Any(v => string.IsNullOrWhiteSpace(v.SKU) || v.Price <= 0)" class="bg-primary text-white px-6 py-2 rounded-lg
             disabled:opacity-50 disabled:cursor-not-allowed
             hover:bg-ctaHover" @onclick="CreateVariants">
        Create Variants
      </button>
    </div>
  }

  @if (createdVariants.Any())
  {
    <div class="mt-10 border-t pt-6">
      <h3 class="text-lg font-semibold mb-3">
        Created Variants
      </h3>

      @foreach (var v in createdVariants)
      {
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-center border rounded-lg p-3 mb-2">
          <div class="font-medium text-sm">
            @v.SKU
          </div>

          <div class="text-xs text-gray-600 col-span-2">
            @string.Join(", ", v.Options.Select(o => $"{o.Key}: {o.Value}"))
          </div>

          <div class="text-sm">
            KES @v.Price
          </div>

          <div class="text-sm">
            Stock: @v.stock
          </div>
        </div>
      }

      <button class="mt-6 text-primary underline" @onclick="ResetAll">
        Create another product
      </button>
    </div>
  }

</div>

@code {
  [Parameter] public Guid ProductId { get; set; }
  private string optionName = string.Empty;
  private class OptionUi
  {
    public Guid Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public bool IsNameLocked { get; set; }
    public string PendingValues { get; set; } = string.Empty;
    public List<string> Values { get; set; } = new();
    public bool AreValuesLocked { get; set; }
  }
  private List<OptionUi> options = new();

  private class VariantDraft
  {
    public string SKU { get; set; } = string.Empty;
    public double Price { get; set; }
    public int Stock { get; set; }
    public string Image { get; set; } = string.Empty;
    public Dictionary<string, string> Options { get; set; } = new();
  }
  private List<VariantDraft> variantDrafts = new();
  private List<CreateVariantResponse> createdVariants = new();

  private async Task AddOptionName()
  {
    if (string.IsNullOrWhiteSpace(optionName))
    {
      ToastService.ShowToast("Option name cannot be empty", string.Empty, ToastService.ToastLevel.Warning);
      return;
    }

    var req = new CreateOptionNameRequest
    {
      ProductId = ProductId,
      Name = optionName
    };

    var result = await ProductService.CreateOptionName(req);
    if (!result.Success || result.Data is null)
    {
      ToastService.ShowToast(
      result.Error?.Detail ?? "Failed to add option",
      string.Empty,
      ToastService.ToastLevel.Error
      );
      return;
    }

    options.Add(new OptionUi
    {
      Id = result.Data.OptionId,
      Name = optionName,
      IsNameLocked = true
    });

    optionName = string.Empty;
  }

  private void DeleteOption(OptionUi opt)
  {
    options.Remove(opt);
  }


  private async Task AddOptionValues(OptionUi opt)
  {
    if (string.IsNullOrWhiteSpace(opt.PendingValues))
    {
      ToastService.ShowToast("Enter values for the option", string.Empty, ToastService.ToastLevel.Warning);
      return;
    }

    var values = opt.PendingValues
    .Split(',')
    .Select(v => v.Trim())
    .Where(v => !string.IsNullOrWhiteSpace(v))
    .ToList();

    if (values.Count == 0)
      return;

    var req = new AddOptionValuesRequest
    {
      ProductId = ProductId,
      OptionId = opt.Id,
      Values = values
    };

    var result = await ProductService.AddOptionValues(req);
    if (result.Success)
    {
      opt.Values = values;
      opt.PendingValues = string.Empty;
      opt.AreValuesLocked = true;

      ToastService.ShowToast($"Values added to {opt.Name}", string.Empty, ToastService.ToastLevel.Success);
      opt.PendingValues = string.Empty;
    }
    else
    {
      ToastService.ShowToast(result.Error?.Detail ?? "Failed to add values", string.Empty, ToastService.ToastLevel.Error);
    }
  }

  private void ClearValues(OptionUi opt)
  {
    opt.Values.Clear();
    opt.AreValuesLocked = false;
  }

  private void BuildVariantDrafts()
  {
    variantDrafts.Clear();

    var opt = options.Single(); // single-option MVP
    var index = 1;
    foreach (var value in opt.Values)
    {
      variantDrafts.Add(new VariantDraft
      {
        SKU = $"APP-{value.ToUpper()}-{index:D3}",
        Options = new Dictionary<string, string>
{
{ opt.Name, value }
}
      });

      index++;
    }
  }

  private async Task CreateVariants()
  {
    foreach (var draft in variantDrafts)
    {
      var req = new CreateVariantRequest
      {
        ProductId = ProductId,
        SKU = draft.SKU,
        Price = draft.Price,
        Stock = draft.Stock,
        Image = draft.Image,
        Options = draft.Options
      };

      var result = await ProductService.CreateVariant(req);
      if (!result.Success || result.Data is null)
      {
        ToastService.ShowToast(
        result.Error?.Detail ?? "Failed to create variant",
        string.Empty,
        ToastService.ToastLevel.Error
        );
        return;
      }

      createdVariants.Add(result.Data);
    }

    ToastService.ShowToast("Variants created successfully", string.Empty, ToastService.ToastLevel.Success);
  }

  private void ResetAll()
  {
    options.Clear();
    variantDrafts.Clear();
    createdVariants.Clear();
  }
}