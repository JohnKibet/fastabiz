@using frontend.Models
@inject ProductService ProductService
@inject ToastService ToastService

<div class="mt-6 border-t pt-4">
  <h2 class="text-lg font-semibold text-textDark mb-2">Product Variants</h2>

  <!-- Add Option Names -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium text-textDark">Option Name</label>
      <InputText @bind-Value="optionName" class="w-full mt-1 px-4 py-2 border rounded-lg" />
    </div>
    <div class="flex items-end">
      <button @onclick="AddOptionName" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-ctaHover">Add
        Option</button>
    </div>
  </div>

  <!-- List of Option Names -->
  <ul class="mt-2">
    @foreach (var opt in options)
    {
      <div class="mt-4 border p-3 rounded-lg">
        <h3 class="text-sm font-medium text-textDark">@opt.Name</h3>
        <div class="flex space-x-2 mt-2">
          <InputText @bind-Value="optionValues[opt.Name]" class="w-full px-3 py-1 border rounded-lg"
            placeholder="Comma separated values" />
          <button @onclick="() => AddOptionValues(opt)"
            class="bg-primary text-white px-3 py-1 rounded-lg hover:bg-ctaHover">Add Values</button>
        </div>
      </div>
    }
  </ul>
</div>

@code {
  [Parameter] public Guid ProductId { get; set; }
  private string optionName = string.Empty;
  private Guid createdOptionId;
  private List<CreateOptionNameRequest> options = new();
  private Dictionary<string, string> optionValues = new();

  private async Task AddOptionName()
  {
    if (string.IsNullOrWhiteSpace(optionName))
    {
      ToastService.ShowToast("Option name cannot be empty", string.Empty, ToastService.ToastLevel.Warning);
      return;
    }

    var req = new CreateOptionNameRequest
    {
      ProductId = ProductId,
      Name = optionName
    };

    var result = await ProductService.CreateOptionName(req);
    if (result.Success)
    {
      options.Add(req);
      optionName = string.Empty;
      createdOptionId = result.Data!.OptionId; // handle null result data
      StateHasChanged();
    }
    else
    {
      ToastService.ShowToast(result.Error?.Detail ?? "Failed to add option", string.Empty, ToastService.ToastLevel.Error);
    }
  }

  private async Task AddOptionValues(CreateOptionNameRequest opt)
  {
    if (!optionValues.ContainsKey(opt.Name) || string.IsNullOrWhiteSpace(optionValues[opt.Name]))
    {
      ToastService.ShowToast("Enter values for the option", string.Empty, ToastService.ToastLevel.Warning);
      return;
    }

    var values = optionValues[opt.Name].Split(',').Select(v => v.Trim()).Where(v => !string.IsNullOrWhiteSpace(v)).ToList();
    if (values.Count == 0) return;

    var req = new AddOptionValuesRequest
    {
      ProductId = ProductId,
      OptionId = createdOptionId,
      Values = values
    };

    var result = await ProductService.AddOptionValues(req);
    if (result.Success)
    {
      ToastService.ShowToast($"Values added to {opt.Name}", string.Empty, ToastService.ToastLevel.Success);
      optionValues[opt.Name] = string.Empty;
    }
    else
    {
      ToastService.ShowToast(result.Error?.Detail ?? "Failed to add values", string.Empty, ToastService.ToastLevel.Error);
    }
  }
}