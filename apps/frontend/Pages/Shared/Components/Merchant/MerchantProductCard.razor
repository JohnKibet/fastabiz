@using frontend.Models
@namespace frontend.Pages.Shared.Components.Merchant
@inject ProductService ProductService
@inject ToastService ToastService

@if (Product != null)
{
  <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow transition">
    <div class="flex gap-4">
      <!-- Image -->
      <img src="@Product.ImageUrl.FirstOrDefault() ?? '/img/placeholder.png'" class="w-20 h-20 object-cover rounded" />

      <!-- Info -->
      <div class="flex-1">
        <div class="flex justify-between items-start">
          <h3 class="font-semibold text-lg">@Product.Name</h3>

          @if (IsNew)
          {
            <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
              New
            </span>
          }

          <span class="text-xs px-2 py-1 rounded bg-gray-100">
            @Product.Category
          </span>
        </div>

        <p class="text-sm text-gray-500 line-clamp-2">
          @Product.Description
        </p>

        <p class="text-xs text-gray-400 mt-1">
          On sale: @TimeOnSale
        </p>

        <!-- Inventory / Variants -->
        <div class="mt-2 text-sm">
          @if (Product.HasVariants)
          {
            <span class="text-blue-600">
              @Product.VariantCount variants
            </span>
            <span class="ml-3 text-gray-600">
              Price: KES @Product.MinPrice â€“ @Product.MaxPrice
            </span>
          }
          else
          {
            <span class="text-gray-700">
              Price: KES @Product.Price
            </span>
            <span class="ml-3 @(Product.Stock < 10 ? "text-red-600" : "text-green-600")">
              Stock: @Product.Stock
            </span>
          }
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="mt-4 flex justify-end gap-2">
      <button class="btn-secondary" @onclick="Edit">Edit</button>
      <button class="btn-outline" @onclick="ManageVariants">Variants</button>
      <button class="btn-danger" disabled="@isDeleting" @onclick="Delete">Delete</button>
    </div>
  </div>

}

@code {
  [Parameter] public ProductListItem? Product { get; set; }
  [Parameter] public EventCallback<Guid> OnEdit { get; set; }
  [Parameter] public EventCallback<Guid> OnDelete { get; set; }
  [Parameter] public EventCallback<Guid> OnManageVariants { get; set; }
  [CascadingParameter] private ActiveProductContext? ActiveProduct { get; set; }
  [Inject] NavigationManager Navigation { get; set; } = default!;
  bool isDeleting = false;

  private async Task Delete()
  {
    if (Product == null) return;
    isDeleting = true;
    var response = await ProductService.DeleteProduct(Product.Id);
    if (!response.Success)
    {
      ToastService.ShowToast(response.Error?.Detail ?? "Delete failed, try again later.", string.Empty,
      ToastService.ToastLevel.Error);
      return;
    }

    ToastService.ShowToast("Product deleted.", string.Empty, ToastService.ToastLevel.Success);
    await OnDelete.InvokeAsync(Product.Id);
    isDeleting = false;
  }
  private Task ManageVariants() => OnManageVariants.InvokeAsync(Product!.Id);

  private void Edit()
  {
    if (Product == null) return;
    if (ActiveProduct != null)
    {
      ActiveProduct.ProductId = Product.Id;
      ActiveProduct.ProductName = Product.Name;
    }
    else return;

    Navigation.NavigateTo($"/merchant/products/{Product.Id}?mode=edit");
  }

  private string TimeOnSale
  {
    get
    {
      if (Product == null)
        return "";

      var days = (DateTime.UtcNow - Product.CreatedAt).Days;

      if (days <= 0)
        return "Today";

      if (days == 1)
        return "1 day ago";

      return $"{days} days ago";
    }
  }

  private bool IsNew
  {
    get
    {
      if (Product == null)
        return false;

      return (DateTime.UtcNow - Product.CreatedAt).Days < 7;
    }
  }


}