@using frontend.Models
@namespace frontend.Pages.Shared.Components.Storefront

@if (Options.Any() == true && Variants?.Any() == true)
{
    <div class="space-y-4">
        @foreach (var option in Options)
        {
            <div>
                <label class="block font-semibold mb-2">@option.Name</label>
                <div class="flex gap-2 flex-wrap">
                    @foreach (var val in option.Values)
                    {
                        bool unavailable = IsValueUnavailable(option.Name, val);

                        <button disabled="@unavailable" 
                                class="@GetValueClass(option.Name, val, unavailable)"
                                @onclick="() => SelectOption(option.Name, val)">
                            @val
                        </button>
                    }
                </div>
            </div>
        }

        @if (Selected.Values.Any(v => !string.IsNullOrEmpty(v)))
        {
            <button class="mt-2 px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-100 text-gray-700"
                @onclick="ClearSelections">
                Clear Selection
            </button>
        }
    </div>
}

@code {
    [Parameter] public List<ProductMapper.OptionDto> Options { get; set; } = new();
    [Parameter] public List<ProductMapper.VariantDto> Variants { get; set; } = new();

    [Parameter] public EventCallback<ProductMapper.VariantDto?> OnVariantSelected { get; set; }
    [Parameter] public EventCallback<Dictionary<string, string?>> OnSelectionChanged { get; set; }

    private Dictionary<string, string?> Selected = new();
    private bool _hasInitialized = false;

    protected override void OnParametersSet()
    {
        if (!_hasInitialized && Options?.Any() == true)
        {
            foreach (var opt in Options)
            {
                if (!Selected.ContainsKey(opt.Name))
                    Selected[opt.Name] = null;
            }

            EmitSelectedVariant();
            _hasInitialized = true;
        }
    }

    private void SelectOption(string optionName, string value)
    {
        Selected[optionName] = value;
        EmitSelectedVariant();
        OnSelectionChanged.InvokeAsync(Selected);
    }

    private void ClearSelections()
    {
        foreach (var opt in Options)
            Selected[opt.Name] = null;

        EmitSelectedVariant();
        OnSelectionChanged.InvokeAsync(Selected);
    }

    private bool IsValueUnavailable(string optionName, string value)
    {
        var temp = new Dictionary<string, string?>(Selected)
        {
            [optionName] = value
        };

        return !Variants.Any(v =>
        v.Options.All(kv =>
        temp.ContainsKey(kv.Key) &&
        (temp[kv.Key] == null || temp[kv.Key] == kv.Value)));
    }
    private void EmitSelectedVariant()
    {
        var match = Variants.FirstOrDefault(v =>
        v.Options.All(opt =>
        Selected.ContainsKey(opt.Key) &&
        Selected[opt.Key] == opt.Value));

        // fallback: select first variant if none selected
        if (match == null && Variants.Any())
        {
            match = Variants.First();
            foreach (var opt in match.Options)
                Selected[opt.Key] = opt.Value;

            StateHasChanged(); // ensure buttons render immediately
        }

        OnVariantSelected.InvokeAsync(match);
    }

    private string GetValueClass(string optionName, string value, bool unavailable)
    {
        bool isActive = Selected.TryGetValue(optionName, out var current) && current == value;

        if (unavailable)
            return "px-3 py-1 rounded-lg border border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed";

        if (isActive)
            return "px-3 py-1 rounded-lg border border-blue-600 bg-blue-50 text-blue-700";

        return "px-3 py-1 rounded-lg border border-gray-300 hover:border-gray-600 cursor-pointer";
    }
}