@using System.Globalization
@typeparam TValue

<div>
    <label class="block text-sm font-medium text-gray-700">@Label</label>

    @if (IsEditing)
    {
        @if (FieldType == "select" && Options != null)
        {
            <select class="w-full px-3 py-2 border rounded-md" 
                value="@BindConverter.FormatValue(Value)" 
                @onchange="OnValueChanged"
            >
                @foreach (var opt in Options)
                {
                    <option value="@opt">@opt</option>
                }
            </select>
        }
        else
        {
            <input class="w-full px-3 py-2 border rounded-md"
                value="@BindConverter.FormatValue(Value)"
                @onchange="OnValueChanged" 
            />
        }
    }
    else
    {
        <p class="text-gray-800">@Value</p>
    }
</div>

@code {
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public TValue Value { get; set; } = default!;
    [Parameter] public EventCallback<TValue> ValueChanged { get; set; }
    [Parameter] public bool IsEditing { get; set; }
    [Parameter] public string FieldType { get; set; } = "text";
    [Parameter] public List<string>? Options { get; set; }

    private async Task OnValueChanged(ChangeEventArgs e)
    {
        if (typeof(TValue) == typeof(UserStatus?))
        {
            if (Enum.TryParse<UserStatus>(e.Value?.ToString(), out var status))
            {
                Value = (TValue)(object)status;
                await ValueChanged.InvokeAsync(Value);
            }
        }
        else
        {
            var strValue = e.Value?.ToString();
            if (BindConverter.TryConvertTo<TValue>(strValue, CultureInfo.InvariantCulture, out var typedValue))
            {
                Value = typedValue;
                await ValueChanged.InvokeAsync(typedValue);
            }
        }

        Console.WriteLine($"Selected: {e.Value}, Parsed: {Value}");
    }
}
