@page "/storefront"
@layout PublicLayout
@using frontend.Models
@using frontend.Pages.Shared.Components.Storefront
@inject NavigationManager NavigationManager

<h3>Storefront</h3>

<div class="storefront-container flex">
    <!-- Sidebar Filters -->
    <aside class="w-1/4 p-4 border-r">
        <h4>Categories</h4>
        <CategoryFilter Categories="@Categories" SelectedCategory="@SelectedCategory" OnCategorySelected="@FilterByCategory" />

        <h4 class="mt-6">Merchants</h4>
        <MerchantFilter Merchants="@Merchants" OnMerchantSelected="@FilterByMerchant" />
    </aside>

    <!-- Products Grid -->
    <main class="w-3/4 p-4 grid grid-cols-3 gap-6">
        @foreach (var product in FilteredProducts)
        {
            <ProductCard Product="@product" OnSelected="@ViewProductDetail" />
        }
    </main>
</div>

<!-- Pagination (optional) -->
<PaginationControl CurrentPage="@CurrentPage" TotalPages="@TotalPages"
                   OnPreviousPage="@LoadPreviousPage"
                   OnNextPage="@LoadNextPage" />


@code {
    // Mock Data (can be replaced by API call)
    private List<ProductListItem> Products = MockData.GetAllProducts();
    private List<ProductListItem> FilteredProducts = new();
    private List<string> Categories = MockData.GetAllCategories();
    private List<Merchant> Merchants = MockData.Merchants;

    private string? SelectedCategory;
    private string? SelectedMerchantId;

    private int CurrentPage = 1;
    private int TotalPages = 1;

    protected override void OnInitialized()
    {
        FilteredProducts = Products;
        TotalPages = (int)Math.Ceiling((double)Products.Count / 9); // example: 9 per page
    }

    private void FilterByCategory(string category)
    {
        SelectedCategory = category;
        ApplyFilters();
    }

    private void FilterByMerchant(string merchantId)
    {
        SelectedMerchantId = merchantId;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredProducts = Products;

        if (!string.IsNullOrEmpty(SelectedCategory))
            FilteredProducts = FilteredProducts.Where(p => p.Category == SelectedCategory).ToList();

        if (!string.IsNullOrEmpty(SelectedMerchantId))
            FilteredProducts = FilteredProducts.Where(p => p.MerchantId == SelectedMerchantId).ToList();

        // reset pagination
        CurrentPage = 1;
        TotalPages = (int)Math.Ceiling((double)FilteredProducts.Count / 9);
    }

    private async Task LoadPreviousPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    private async Task LoadNextPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    private void ViewProductDetail(ProductListItem product)
    {
        NavigationManager.NavigateTo($"/product/{product.Id}");
    }
}
