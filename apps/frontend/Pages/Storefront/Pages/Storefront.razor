@page "/storefront"
@layout StorefrontLayout
@inject ProductService ProductService
@inject NavigationManager NavigationManager

<div class="px-4">
    <div class="storefront-container flex">
        <!-- Products Grid -->
        <main class="w-full grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            @foreach (var product in Products)
            {
                <ProductCard Product="@product" OnSelected="@ViewProductDetail" />
            }
        </main>
    </div>

    <!-- Pagination (optional) -->
    <PaginationControls CurrentPage="@CurrentPage" TotalPages="@TotalPages" OnPreviousPage="@LoadPreviousPage"
        OnNextPage="@LoadNextPage" />
</div>

@code {
    [CascadingParameter] StorefrontLayout? Layout { get; set; }
    [CascadingParameter] ActiveStoreContext ActiveStore { get; set; } = new();

    private List<ProductListItem> Products = new();

    private int CurrentPage = 1;
    private int TotalPages = 1;

    private bool _hasLoadedProducts = false;

    protected override async Task OnParametersSetAsync()
    {
        // Only load if we have a valid store ID and haven't loaded yet
        if (!_hasLoadedProducts && ActiveStore != null && ActiveStore.StoreId != Guid.Empty)
        {
            var result = await ProductService.ListAllStoreProducts(ActiveStore.StoreId);
            if (result.Success && result.Data != null)
            {
                Products = result.Data;
            }
            else
            {
                Console.Error.WriteLine("Failed to load products: " + result.Error);
            }

            TotalPages = (int)Math.Ceiling((double)Products.Count / 9);
            _hasLoadedProducts = true;

            Layout?.SetBreadcrumbs(new List<BreadcrumbItem>
{
new() { Title = "Home", Url = "/storefront" },
new() { Title = "Products", Url = "/storefront" }
});

            StateHasChanged();
        }
    }

    private async Task LoadPreviousPage(int page) => CurrentPage = page;
    private async Task LoadNextPage(int page) => CurrentPage = page;

    private void ViewProductDetail(ProductListItem product)
    => NavigationManager.NavigateTo($"/product/{product.Id}");
}