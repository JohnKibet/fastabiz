@page "/store/{StoreId:guid}"
@layout StorefrontLayout
@inject ProductService ProductService
@inject NavigationManager Nav

<div class="p-4 space-y-6">
    <!-- Store Header -->
    <header class="flex items-center gap-4">
        @if (!string.IsNullOrEmpty(StoreLogo))
        {
            <img src="@StoreLogo" alt="@StoreName" class="w-16 h-16 rounded-full object-cover" />
        }

        <div>
            <h3 class="text-2xl font-bold">@StoreName</h3>
            <p class="text-sm text-yellow-600">‚≠ê @StoreRating.ToString("0.0")</p>
            <p class="text-sm text-gray-600">@AllProducts.Count product(s)</p>
        </div>
    </header>

    <!-- Category Filters -->
    <div class="flex gap-2 overflow-x-auto">
        @foreach (var cat in Categories)
        {
            <button class="px-3 py-1 rounded-full border text-sm whitespace-nowrap
                           @(SelectedCategory == cat
                                             ? "bg-blue-600 text-white border-blue-600"
                                             : "bg-gray-100 text-gray-700 hover:bg-gray-200")" @onclick="() => ApplyCategory(cat)">
                @cat
            </button>
        }

        @if (!string.IsNullOrEmpty(SelectedCategory))
        {
            <button class="px-3 py-1 rounded-full border bg-red-100 text-red-600 text-sm" @onclick="ClearCategory">
                Clear
            </button>
        }
    </div>

    <!-- Products Grid -->
    <main class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        @foreach (var product in PagedProducts)
        {
            <ProductCard Product="@product" OnSelected="@ViewProduct" />
        }
    </main>

    <!-- Pagination -->
    <PaginationControl CurrentPage="@CurrentPage" TotalPages="@TotalPages" OnPreviousPage="@SetPage"
        OnNextPage="@SetPage" />
</div>

@code {
    [Parameter] public Guid StoreId { get; set; }
    [CascadingParameter] public ActiveStoreContext? ActiveStore { get; set; }
    [CascadingParameter] StorefrontLayout? Layout { get; set; }

    private List<ProductListItem> AllProducts = new();
    private List<ProductListItem> FilteredProducts = new();
    private List<string> Categories = new();

    private string? SelectedCategory;

    private int CurrentPage = 1;
    private const int PageSize = 9;
    private int TotalPages => (int)Math.Ceiling((double)FilteredProducts.Count / PageSize);

    // Store display
    private string StoreName = "";
    private string? StoreLogo;
    private double StoreRating;

    protected override async Task OnInitializedAsync()
    {
        var storeId = StoreId != Guid.Empty
        ? StoreId
        : ActiveStore?.StoreId ?? Guid.Empty;

        if (storeId == Guid.Empty) return;

        StoreName = ActiveStore?.StoreName ?? "Store";

        var result = await ProductService.ListAllStoreProducts(storeId);
        if (!result.Success || result.Data is null) return;

        AllProducts = result.Data;
        Categories = AllProducts
        .Select(p => p.Category)
        .Where(c => !string.IsNullOrWhiteSpace(c))
        .Distinct()
        .OrderBy(c => c)
        .ToList();

        ApplyFilters();

        Layout?.SetBreadcrumbs(new()
{
new() { Title = "Home", Url = "/" },
new() { Title = "Stores", Url = "/stores" },
new() { Title = StoreName, Url = $"/store/{storeId}" }
});
    }

    private void ApplyCategory(string category)
    {
        SelectedCategory = category;
        ApplyFilters();
    }

    private void ClearCategory()
    {
        SelectedCategory = null;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredProducts = string.IsNullOrEmpty(SelectedCategory)
        ? AllProducts
        : AllProducts.Where(p => p.Category == SelectedCategory).ToList();

        CurrentPage = 1;
    }

    private IEnumerable<ProductListItem> PagedProducts =>
    FilteredProducts
    .Skip((CurrentPage - 1) * PageSize)
    .Take(PageSize);

    private void SetPage(int page) => CurrentPage = page;

    private void ViewProduct(ProductListItem product) =>
    Nav.NavigateTo($"/product/{product.Id}");
}