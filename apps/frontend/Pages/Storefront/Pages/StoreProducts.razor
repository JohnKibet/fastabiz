@page "/store/{MerchantId}"
@layout StorefrontLayout
@inject NavigationManager NavigationManager

<h3 class="text-2xl font-bold mb-4">@Merchant?.Name</h3>

<div class="flex mb-6">
    <!-- Merchant Info -->
    <div class="flex items-center space-x-4">
        @if (!string.IsNullOrEmpty(Merchant?.Logo))
        {
            <img src="@Merchant.Logo" alt="@Merchant.Name" class="w-16 h-16 rounded-full object-cover" />
        }
        <div>
            <p class="text-lg font-semibold">@Merchant?.Name</p>
            <p class="text-sm text-yellow-600">‚≠ê @Merchant?.Rating.ToString("0.0")</p>
            <p class="text-sm text-gray-600">@Merchant?.TotalProducts product(s)</p>
        </div>
    </div>
</div>

<div class="flex">
    <!-- Sidebar Category Filter -->
    <aside class="w-1/4 pr-4">
        <h4 class="font-semibold mb-2">Categories</h4>
        <CategoryFilter 
            Categories="@Categories" 
            SelectedCategory="@SelectedCategory" 
            OnCategorySelected="@FilterByCategory" />
    </aside>

    <!-- Products Grid -->
    <main class="w-3/4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        @foreach (var product in FilteredProducts)
        {
            <ProductCard Product="@ConvertToListItem(product)" OnSelected="@ViewProductDetail" />
        }
    </main>
</div>

<!-- Pagination -->
<PaginationControl CurrentPage="@CurrentPage" TotalPages="@TotalPages"
                   OnPreviousPage="@LoadPreviousPage"
                   OnNextPage="@LoadNextPage" />

@code {
    [Parameter] public string MerchantId { get; set; } = string.Empty;
    [CascadingParameter] StorefrontLayout Layout { get; set; }

    private Merchant? Merchant;
    private List<ProductX> FilteredProducts = new();
    private List<string> Categories = new();
    private string? SelectedCategory;

    private int CurrentPage = 1;
    private int TotalPages = 1;
    private const int PageSize = 9;

    protected override void OnInitialized()
    {
        // Find the merchant
        Merchant = MockData.Merchants.FirstOrDefault(m => m.Id == MerchantId);

        if (Merchant != null)
        {
            FilteredProducts = Merchant.Products;
            Categories = Merchant.Products.Select(p => p.Category).Distinct().OrderBy(c => c).ToList();
            TotalPages = (int)Math.Ceiling((double)FilteredProducts.Count / PageSize);

            Layout?.SetBreadcrumbs(new List<BreadcrumbItem>
            {
                new() { Title = "Home", Url = "/" },
                new() { Title = "Stores", Url = "/stores" },
                new() { Title = $"{Merchant?.Name}", Url = $"/store{MerchantId}" }
            });
        }
    }

    private void FilterByCategory(string category)
    {
        SelectedCategory = category;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (Merchant is null) return;

        FilteredProducts = Merchant.Products;

        if (!string.IsNullOrEmpty(SelectedCategory))
            FilteredProducts = FilteredProducts.Where(p => p.Category == SelectedCategory).ToList();

        CurrentPage = 1;
        TotalPages = (int)Math.Ceiling((double)FilteredProducts.Count / PageSize);
    }

    private async Task LoadPreviousPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    private async Task LoadNextPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    private void ViewProductDetail(ProductListItem product)
    {
        NavigationManager.NavigateTo($"/product/{product.Id}");
    }

    // Helper to convert ProductX to ProductListItem for ProductCard
    private ProductListItem ConvertToListItem(ProductX p)
    {
        return new ProductListItem
        {
            Id = p.Id,
            Name = p.Name,
            Category = p.Category,
            Thumbnail = p.Images.FirstOrDefault() ?? "https://via.placeholder.com/150",
            HasVariants = p.HasVariants,
            Price = p.Price,
            MinPrice = p.MinPrice,
            MaxPrice = p.MaxPrice,
            MerchantId = Merchant?.Id ?? "",
            MerchantName = Merchant?.Name ?? "",
            Rating = Merchant?.Rating ?? 0,
            TotalSold = new Random().Next(10, 200) // mock sold count
        };
    }
}
