@page "/store/{StoreId}"
@layout StorefrontLayout
@inject NavigationManager NavigationManager

<div class="p-2">
    <h3 class="text-2xl font-bold mb-4">@Store?.Name</h3>

    <div class="flex mb-6">
        <!-- Store Info -->
        <div class="flex items-center space-x-4">
            @if (!string.IsNullOrEmpty(Store?.LogoUrl))
            {
                <img src="@Store.LogoUrl" alt="@Store.Name" class="w-16 h-16 rounded-full object-cover" />
            }
            <div>
                <p class="text-sm text-yellow-600">‚≠ê @Store?.Rating.ToString("0.0")</p>
                <p class="text-sm text-gray-600">@Store?.TotalProducts product(s)</p>
            </div>
        </div>
    </div>

    <div class="flex">
        <!-- CATEGORY FILTERS -->
        <div class="flex-1/2 space-x-2 overflow-x-auto py-2 px-1">
            @foreach (var cat in Categories)
            {
                <button class="px-3 py-1 rounded-full border text-sm whitespace-nowrap
                                    @(SelectedCategory == cat
                                                            ? "bg-blue-600 text-white border-blue-600" 
                                                            : "bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200")"
                    @onclick="() => FilterByCategory(cat)">
                    @cat
                </button>
            }
            @if (!string.IsNullOrEmpty(SelectedCategory))
            {
                <button class="px-3 py-1 rounded-full border bg-red-100 text-red-600 text-sm"
                    @onclick="() => FilterByCategory(null)">
                    Clear
                </button>
            }
        </div>

        <!-- Products Grid -->
        <main class="w-3/4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            @foreach (var product in FilteredProducts)
            {
                <ProductCard Product="@ConvertToListItem(product)" OnSelected="@ViewProductDetail" />
            }
        </main>
    </div>

    <!-- Pagination -->
    <PaginationControl CurrentPage="@CurrentPage" TotalPages="@TotalPages" OnPreviousPage="@LoadPreviousPage"
        OnNextPage="@LoadNextPage" />
</div>

@code {
    [Parameter] public Guid StoreId { get; set; }
    [CascadingParameter] StorefrontLayout? Layout { get; set; }

    private Store? Store;
    private List<ProductX> FilteredProducts = new();
    private List<string> Categories = new();
    private string? SelectedCategory;

    private int CurrentPage = 1;
    private int TotalPages = 1;
    private const int PageSize = 9;

    protected override void OnInitialized()
    {
        // Find the Store
        Store = MockData.Stores.FirstOrDefault(m => m.Id == StoreId);

        if (Store != null)
        {
            FilteredProducts = Store.Products;
            Categories = Store.Products.Select(p => p.Category).Distinct().OrderBy(c => c).ToList();
            TotalPages = (int)Math.Ceiling((double)FilteredProducts.Count / PageSize);

            Layout?.SetBreadcrumbs(new List<BreadcrumbItem>
{
new() { Title = "Home", Url = "/" },
new() { Title = "Stores", Url = "/stores" },
new() { Title = $"{Store?.Name}", Url = $"/store{StoreId}" }
});
        }
    }

    private void FilterByCategory(string category)
    {
        SelectedCategory = category;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (Store is null) return;

        FilteredProducts = Store.Products;

        if (!string.IsNullOrEmpty(SelectedCategory))
            FilteredProducts = FilteredProducts.Where(p => p.Category == SelectedCategory).ToList();

        CurrentPage = 1;
        TotalPages = (int)Math.Ceiling((double)FilteredProducts.Count / PageSize);
    }

    private async Task LoadPreviousPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    private async Task LoadNextPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    private void ViewProductDetail(ProductListItem product)
    {
        NavigationManager.NavigateTo($"/product/{product.Id}");
    }

    // Helper to convert ProductX to ProductListItem for ProductCard
    private ProductListItem ConvertToListItem(ProductX p)
    {
        return new ProductListItem
        {
            Id = p.Id,
            Name = p.Name,
            Category = p.Category,
            Thumbnail = p.Images.FirstOrDefault() ?? "https://via.placeholder.com/150",
            HasVariants = p.HasVariants,
            Price = p.Price,
            MinPrice = p.MinPrice,
            MaxPrice = p.MaxPrice,
            StoreId = Store!.Id,
            StoreName = Store?.Name ?? "",
            Rating = Store?.Rating ?? 0,
            TotalSold = new Random().Next(10, 200) // mock sold count
        };
    }
}