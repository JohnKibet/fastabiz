@page "/product/{ProductId:guid}"
@page "/product/{ProductId:guid}/{VariantId:guid}"
@using System.Threading.Tasks
@layout StorefrontLayout
@inject NavigationManager Nav
@inject ProductService ProductService
@inject StoreService StoreService

@if (LoadFailed)
{
    <p class="text-red-600">Failed to load product.</p>
}
else if (FetchedProduct is null)
{
    <p>Loading...</p>
}
else
{
    <div class="product-detail grid grid-cols-2 gap-8 p-6 @(IsInCart ? "bg-yellow-50" : "")">

        <!-- LEFT: Image Gallery -->
        <div>
            <ImageGallery Images="@FetchedProduct.Images" />
        </div>

        <!-- RIGHT: Info -->
        <div class="space-y-4">

            <h2 class="text-2xl font-bold">@FetchedProduct.Name</h2>

            <button class="text-blue-600 underline" @onclick="() => ViewStore(FetchedProduct.StoreId)">
                @Store?.Name
            </button>

            <p class="text-gray-700">@FetchedProduct.Description</p>

            <!-- VARIANTS -->
            @if (FetchedProduct.HasVariants)
            {
                <VariantSelector Options="@FetchedProduct.Options" Variants="@FetchedProduct.Variants"
                    OnVariantSelected="SelectVariant" OnSelectionChanged="UpdateSelections" />

                @if (ShowError)
                {
                    <p class="text-red-600 font-medium">
                        This combination is not available. Try different options.
                    </p>
                }
            }

            <!-- PRICE & STOCK -->
            <p class="text-xl font-semibold">
                Price: KES @(GetPriceDisplay())
            </p>
            <p class="text-sm text-gray-500">
                Stock: @(GetStockDisplay())
            </p>

            <!-- QUANTITY SELECTOR -->
            <div class="flex items-center gap-3">
                <button class="px-3 py-1 border rounded-lg text-lg font-bold" @onclick="DecreaseQty"
                    disabled="@(IsInCart || Quantity <= 1)">-</button>

                <span class="min-w-[40px] text-center font-semibold">@Quantity</span>

                <button class="px-3 py-1 border rounded-lg text-lg font-bold" @onclick="IncreaseQty"
                    disabled="@(IsInCart || Quantity >= GetCurrentStock())">+</button>
            </div>

            <!-- ADD / REMOVE FROM CART -->
            @if (IsInCart)
            {
                <button class="w-1/2 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold"
                    @onclick="RemoveFromCart">
                    Remove from Cart
                </button>
            }
            else
            {
                <button disabled="@(!CanAddToCart)" @onclick="AddToCart"
                    class="w-1/2 px-4 py-3 rounded-lg font-semibold
                                                                            @(CanAddToCart ? "bg-green-600 text-white hover:bg-green-700" : "bg-gray-300 text-gray-500 cursor-not-allowed")">
                    Add to Cart
                </button>
            }
        </div>
    </div>
}

@code {
    [CascadingParameter] public ActiveStoreContext? ActiveStore { get; set; }
    [Parameter] public Guid? VariantId { get; set; }
    [Parameter] public Guid ProductId { get; set; }
    [CascadingParameter] StorefrontLayout? Layout { get; set; }
    [Inject] private CartService CartService { get; set; } = default!;

    private ProductMapper.ProductDto? FetchedProduct;
    private StoreDto Store = new();

    private ProductMapper.VariantDto? SelectedVariant;
    private Dictionary<string, string?> Selections = new();
    private bool LoadFailed;
    private Guid? _loadedProductId;
    private Guid? _loadedVariantId;
    private bool IsReady;


    protected override async Task OnParametersSetAsync()
    {
        if (_loadedProductId == ProductId && _loadedVariantId == VariantId)
            return;

        _loadedProductId = ProductId;
        _loadedVariantId = VariantId;

        await LoadProduct();
    }

    private async Task LoadProduct()
    {
        // 1. Initial State
        IsReady = false;
        LoadFailed = false;
        FetchedProduct = null;

        var result = await ProductService.GetProductByID(ProductId);

        if (!result.Success || result.Data is null)
        {
            LoadFailed = true;
            StateHasChanged();
            return;
        }

        // 2. Data Assignment
        FetchedProduct = result.Data;

        // 3. Setup logic (Move this BEFORE IsReady)
        if (VariantId.HasValue && FetchedProduct.HasVariants)
        {
            SelectedVariant = FetchedProduct.Variants
            .FirstOrDefault(v => v.Id == VariantId.Value);

            if (SelectedVariant != null)
            {
                Selections = SelectedVariant.Options
                .ToDictionary(o => o.Key, o => o.Value);
            }
        }

        // 4. Final Transition
        IsReady = true;
        StateHasChanged(); // This is the critical call to swap "Loading..." for the UI
    }


    private void UpdateSelections(Dictionary<string, string?> map)
    {
        Selections = map;

        if (FetchedProduct == null || !FetchedProduct.HasVariants)
            return;

        SelectedVariant = FetchedProduct.Variants.FirstOrDefault(v =>
        v.Options.All(o =>
        Selections.TryGetValue(o.Key, out var val) &&
        val == o.Value
        )
        );

        StateHasChanged();
    }

    private bool AllOptionsSelected =>
    FetchedProduct is not null &&
    FetchedProduct.Options.All(o =>
    Selections.TryGetValue(o.Name, out var v) && v is not null);


    private bool ShowError =>
    FetchedProduct!.Variants.Count > 1 && AllOptionsSelected && SelectedVariant == null;

    private bool CanAddToCart =>
    !FetchedProduct!.HasVariants || // no variants
    FetchedProduct.Variants.Count == 1 || // single variant
    (AllOptionsSelected && SelectedVariant != null); // multiple variants

    private bool IsInCart => CartService.IsInCart(FetchedProduct!.Id, SelectedVariant?.Id);

    private string GetPriceDisplay()
    {
        // No variants (price not implemented yet)
        if (!FetchedProduct!.HasVariants)
            return "-";

        // Single variant
        if (FetchedProduct.Variants.Count == 1)
            return FetchedProduct.Variants[0].Price.ToString("N2");

        // Multiple variants
        if (SelectedVariant != null)
            return SelectedVariant.Price.ToString("N2");

        // Price range (SAFE)
        var prices = FetchedProduct.Variants.Select(v => v.Price).ToList();
        if (!prices.Any())
            return "-";

        double min = prices.Min();
        double max = prices.Max();
        return min == max ? min.ToString("N2") : $"{min:N2} - {max:N2}";
    }

    private string GetStockDisplay()
    {
        if (!FetchedProduct!.HasVariants)
            return "-";

        if (FetchedProduct.Variants.Count == 1)
            return FetchedProduct.Variants[0].Stock.ToString();

        if (SelectedVariant != null)
            return SelectedVariant.Stock.ToString();

        var stocks = FetchedProduct.Variants.Select(v => v.Stock).ToList();
        if (!stocks.Any())
            return "-";

        int min = stocks.Min();
        int max = stocks.Max();
        return min == max ? min.ToString() : $"{min} - {max}";
    }


    private void ViewStore(Guid id) => Nav.NavigateTo($"/store/{id}");

    private void SelectVariant(ProductMapper.VariantDto v)
    {
        SelectedVariant = v;
        StateHasChanged();
    }

    private int Quantity = 1;
    private void IncreaseQty()
    {
        int stock = GetCurrentStock();
        if (Quantity < stock)
            Quantity++;
    }
    private void DecreaseQty()
    {
        if (Quantity > 1)
            Quantity--;
    }

    private int GetCurrentStock()
    {
        if (!FetchedProduct!.HasVariants)
            return int.MaxValue; // allow qty changes for now

        if (FetchedProduct.Variants.Count == 1)
            return FetchedProduct.Variants[0].Stock;

        return SelectedVariant?.Stock ?? 1;
    }


    private async Task AddToCart()
    {
        if (!CanAddToCart) return;

        if (FetchedProduct == null) return;
        ProductMapper.VariantDto? variantToAdd = FetchedProduct.HasVariants ? SelectedVariant : null;

        await CartService.AddItem(FetchedProduct!, variantToAdd, Quantity);
        StateHasChanged();
    }

    private async Task RemoveFromCart()
    {
        await CartService.RemoveItem(FetchedProduct!.Id, SelectedVariant?.Id);
        Quantity = 1;
        if (FetchedProduct.HasVariants && FetchedProduct.Variants.Count > 1)
            SelectedVariant = null; // reset variant selection
        StateHasChanged();
    }
}
