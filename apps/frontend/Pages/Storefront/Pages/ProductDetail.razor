@page "/product/{ProductId}"
@page "/product/{ProductId}/{VariantId}"
@using System.Threading.Tasks
@layout StorefrontLayout
@inject NavigationManager Nav

@if (Product is null)
{
    <p>Loading...</p>
}
else
{
    <div class="product-detail grid grid-cols-2 gap-8 p-6 @(IsInCart ? "bg-yellow-50" : "")">

        <!-- LEFT: Image Gallery -->
        <div>
            <ImageGallery Images="@Product.Images" />
        </div>

        <!-- RIGHT: Info -->
        <div class="space-y-4">

            <h2 class="text-2xl font-bold">@Product.Name</h2>

            <button class="text-blue-600 underline"
                    @onclick="() => ViewMerchant(Product.MerchantId)">
                @Merchant?.Name
            </button>

            <p class="text-gray-700">@Product.Description</p>

            <!-- VARIANTS -->
            @if (Product.HasVariants && Product.Variants.Count > 1)
            {
                <VariantSelector
                    Options="@Product.Options"
                    Variants="@Product.Variants"
                    OnVariantSelected="@SelectVariant"
                    OnSelectionChanged="UpdateSelections" />

                @if (ShowError)
                {
                    <p class="text-red-600 font-medium">
                        This combination is not available. Try different options.
                    </p>
                }
            }

            <!-- PRICE & STOCK -->
            <p class="text-xl font-semibold">
                Price: KES @(GetPriceDisplay())
            </p>
            <p class="text-sm text-gray-500">
                Stock: @(GetStockDisplay())
            </p>

            <!-- QUANTITY SELECTOR -->
            <div class="flex items-center gap-3">
                <button class="px-3 py-1 border rounded-lg text-lg font-bold"
                        @onclick="DecreaseQty"
                        disabled="@(IsInCart || Quantity <= 1)">-</button>

                <span class="min-w-[40px] text-center font-semibold">@Quantity</span>

                <button class="px-3 py-1 border rounded-lg text-lg font-bold"
                        @onclick="IncreaseQty"
                        disabled="@(IsInCart || Quantity >= GetCurrentStock())">+</button>
            </div>

            <!-- ADD / REMOVE FROM CART -->
            @if (IsInCart)
            {
                <button
                    class="w-1/2 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold"
                    @onclick="RemoveFromCart">
                    Remove from Cart
                </button>
            }
            else
            {
                <button class="w-1/2 px-4 py-3 rounded-lg font-semibold
                               @(CanAddToCart ? "bg-green-600 text-white hover:bg-green-700"
                                              : "bg-gray-300 text-gray-500 cursor-not-allowed")"
                        disabled="@(!CanAddToCart)"
                        @onclick="AddToCart">
                    Add to Cart
                </button>
            }
        </div>
    </div>
}

@code {
    [Parameter] public string? VariantId { get; set; }
    [Parameter] public string ProductId { get; set; } = string.Empty;
    [CascadingParameter] StorefrontLayout? Layout { get; set; }
    [Inject] private CartService CartService { get; set; } = default!;

    private ProductX Product = new();
    private Merchant Merchant = new();

    private Variant? SelectedVariant;
    private Dictionary<string, string?> Selections = new();

    protected override void OnInitialized()
    {
        // prefill from cart for changes to be made 
        if(!string.IsNullOrEmpty(VariantId) && Product.HasVariants)
        {
            SelectedVariant = Product.Variants.FirstOrDefault(v => v.Id == VariantId);
            if (SelectedVariant != null)
            {
                foreach (var opt in SelectedVariant.Options)
                {
                    Selections[opt.Key] = opt.Value;
                }
            }
        }

        Product = MockData.Merchants
            .SelectMany(m => m.Products)
            .FirstOrDefault(p => p.Id == ProductId);

        if (Product != null)
        {
            Merchant = MockData.Merchants.First(m => m.Id == Product.MerchantId);
        }

        Layout?.SetBreadcrumbs(new List<BreadcrumbItem>
        {
            new() { Title = "Home", Url = "/" },
            new() { Title = "Stores", Url = "/stores" },
            new() { Title = Merchant?.Name ?? "", Url = $"/store/{Merchant?.Id}" },
            new() { Title = Product?.Name ?? "", Url = $"/product/{ProductId}" }
        });
    }

    private void UpdateSelections(Dictionary<string, string?> map) => Selections = map;

    private bool AllOptionsSelected =>
        Product!.Variants.Count > 1 && // only for multiple variants
        Product.Options.All(o => Selections.ContainsKey(o.Name) && Selections[o.Name] != null);

    private bool ShowError =>
        Product!.Variants.Count > 1 && AllOptionsSelected && SelectedVariant == null;

    private bool CanAddToCart =>
        !Product!.HasVariants ||       // no variants
        Product.Variants.Count == 1 || // single variant
        (AllOptionsSelected && SelectedVariant != null); // multiple variants

    private bool IsInCart => CartService.IsInCart(Product!.Id, SelectedVariant?.Id);

    private string GetPriceDisplay()
    {
        if (!Product!.HasVariants) 
            return Product.Price.ToString("N2") ?? "-";

        if (Product.Variants.Count == 1) 
            return Product.Variants[0].Price.ToString("N2");

        // multiple variants
        if (SelectedVariant != null)
            return SelectedVariant.Price.ToString("N2");

        // Show price range
        var prices = Product.Variants.Select(v => v.Price);
        double min = prices.Min();
        double max = prices.Max();
        return min == max ? min.ToString("N2") : $"{min:N2} - {max:N2}";
    }

    private string GetStockDisplay()
    {
        if (!Product!.HasVariants) 
            return Product.Stock.ToString();

        if (Product.Variants.Count == 1) 
            return Product.Variants[0].Stock.ToString();

        if (SelectedVariant != null)
            return SelectedVariant.Stock.ToString();

        // Show stock range
        var stocks = Product.Variants.Select(v => v.Stock);
        int min = stocks.Min();
        int max = stocks.Max();
        return min == max ? min.ToString() : $"{min} - {max}";
    }

    private void ViewMerchant(string id) => Nav.NavigateTo($"/store/{id}");

    private void SelectVariant(Variant v)
    {
        SelectedVariant = v;
        StateHasChanged();
    }

    private int Quantity = 1;
    private void IncreaseQty()
    {
        int stock = GetCurrentStock();
        if (Quantity < stock)
            Quantity++;
    }
    private void DecreaseQty()
    {
        if (Quantity > 1)
            Quantity--;
    }

    private int GetCurrentStock()
    {
        if (!Product!.HasVariants)
            return Product.Stock;
        
        if (Product.Variants.Count == 1)
            return Product.Variants[0].Stock;

        return SelectedVariant?.Stock ?? 1;
    }

    private async Task AddToCart()
    {
        if (!CanAddToCart) return;

        Variant? variantToAdd = Product.HasVariants ? SelectedVariant : null;

        await CartService.AddItem(Product!, variantToAdd, Quantity);
        StateHasChanged();
    }

    private async Task RemoveFromCart()
    {
        await CartService.RemoveItem(Product!.Id, SelectedVariant?.Id);
        Quantity = 1;
        if (Product.HasVariants && Product.Variants.Count > 1)
            SelectedVariant = null; // reset variant selection
        StateHasChanged();
    }
}