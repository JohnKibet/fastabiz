@page "/category/{Category}"
@using frontend.Models
@namespace frontend.Pages.Storefront
@using frontend.Pages.Shared.Components.Storefront

@inject NavigationManager NavigationManager

<h3 class="text-2xl font-bold mb-4">Category: @Category</h3>

<div class="flex mb-6">
    <!-- Sidebar: Merchant Filter -->
    <aside class="w-1/4 pr-4">
        <h4 class="font-semibold mb-2">Merchants</h4>
        <MerchantFilter 
            Merchants="@Merchants" 
            SelectedMerchantId="@SelectedMerchantId" 
            OnMerchantSelected="@FilterByMerchant" />
    </aside>

    <!-- Products Grid -->
    <main class="w-3/4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        @foreach (var product in FilteredProducts)
        {
            <ProductCard Product="@ConvertToListItem(product)" OnSelected="@ViewProductDetail" />
        }
    </main>
</div>

<!-- Pagination -->
<PaginationControl CurrentPage="@CurrentPage" TotalPages="@TotalPages"
                   OnPreviousPage="@LoadPreviousPage"
                   OnNextPage="@LoadNextPage" />

@code {
    [Parameter] public string Category { get; set; } = string.Empty;

    private List<ProductX> FilteredProducts = new();
    private List<Merchant> Merchants = MockData.Merchants;
    private string? SelectedMerchantId;

    private int CurrentPage = 1;
    private int TotalPages = 1;
    private const int PageSize = 9;

    protected override void OnInitialized()
    {
        ApplyFilters();
    }

    private void FilterByMerchant(string merchantId)
    {
        SelectedMerchantId = merchantId;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        // Start with all products in this category
        FilteredProducts = MockData.Merchants
            .SelectMany(m => m.Products)
            .Where(p => p.Category.Equals(Category, StringComparison.OrdinalIgnoreCase))
            .ToList();

        // Filter by merchant if selected
        if (!string.IsNullOrEmpty(SelectedMerchantId))
        {
            FilteredProducts = FilteredProducts
                .Where(p => p.MerchantId == SelectedMerchantId)
                .ToList();
        }

        CurrentPage = 1;
        TotalPages = (int)Math.Ceiling((double)FilteredProducts.Count / PageSize);
    }

    private void ViewProductDetail(ProductListItem product)
    {
        NavigationManager.NavigateTo($"/product/{product.Id}");
    }

    private async Task LoadPreviousPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    private async Task LoadNextPage(int page)
    {
        CurrentPage = page;
        // fetch page data if needed
    }

    // Helper: convert ProductX â†’ ProductListItem for ProductCard
    private ProductListItem ConvertToListItem(ProductX p)
    {
        var merchant = Merchants.FirstOrDefault(m => m.Id == p.MerchantId);
        return new ProductListItem
        {
            Id = p.Id,
            Name = p.Name,
            Category = p.Category,
            Thumbnail = p.Images.FirstOrDefault() ?? "https://via.placeholder.com/150",
            HasVariants = p.HasVariants,
            Price = p.Price,
            MinPrice = p.MinPrice,
            MaxPrice = p.MaxPrice,
            MerchantId = merchant?.Id ?? "",
            MerchantName = merchant?.Name ?? "",
            Rating = merchant?.Rating ?? 0,
            TotalSold = new Random().Next(10, 200)
        };
    }
}
