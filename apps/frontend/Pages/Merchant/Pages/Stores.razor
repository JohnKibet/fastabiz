@page "/merchant/stores"
@layout MerchantLayout
@inject StoreService StoreService
@inject ToastService ToastService
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "merchant")]

<h2 class="text-2xl font-semibold text-gray-800 mb-6">Store Management</h2>

<!-- Top Actions -->
<div class="flex items-center justify-between mb-4">
  <button class="btn btn-primary" @onclick="CreateStore">
    + Create Store
  </button>

  <div>
    <strong>Total Stores:</strong> @stores?.Count
  </div>
</div>

<!-- Search -->
<div class="mb-6">
  <input type="text"
    class="w-full pl-4 pr-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
    placeholder="Search stores by name or location..." @bind="searchTerm" @bind:event="oninput" />
</div>

@if (stores == null)
{
  <div class="text-gray-500">Loading stores...</div>
}
else if (!FilteredStores.Any())
{
  <div class="text-gray-600">No stores found.</div>
}
else
{
  <div class="overflow-x-auto bg-white shadow-sm border rounded-lg">
    <!-- Stores Table -->
    <StoreTable
      PagedStores="FilteredStores.ToList()"
      CurrentPage="currentPage"
      PageSize="pageSize"
      OnView="ViewStore"
      OnEdit="EditStore"
      OnDelete="ConfirmDelete"
    />
  </div>
}

<!-- View / Edit Modal -->
<TableRowModal TModel="UpdateStoreRequest" IsOpen="isModalOpen" Model="editableStore" IsEditMode="isEditMode"
  Close="CloseModal" EnableEdit="@(() => isEditMode = true)" Save="SaveChanges" Fields="storeFields" />

<!-- Delete Modal -->
<DeleteConfirmationModal IsVisible="isDeleteModalOpen" IsVisibleChanged="@(v => isDeleteModalOpen = v)"
  Message="Delete this store?" TargetName="@selectedStoreName" OnConfirm="DeleteStore" />

@code {
  private List<Store>? stores;
  private string searchTerm = "";
  private int currentPage = 1;
  private int pageSize = 10;

  private Store? selectedStore;
  private UpdateStoreRequest editableStore = new();

  private bool isModalOpen;
  private bool isEditMode;

  private bool isDeleteModalOpen;
  private Guid storeToDeleteId;
  private string selectedStoreName = "";

  private List<IFieldDefinitionBase> storeFields = new();

  protected override async Task OnInitializedAsync()
  {
    await LoadStores();
  }

  private async Task LoadStores()
  {
    var result = await StoreService.GetAllStores();
    stores = result.Success && result.Data != null
    ? result.Data
    : new List<Store>();
  }

  private IEnumerable<Store> FilteredStores =>
  stores?.Where(s =>
  string.IsNullOrWhiteSpace(searchTerm) ||
  s.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
  s.Location.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
  ) ?? Enumerable.Empty<Store>();

  private void CreateStore()
  {
    Navigation.NavigateTo("/merchant/stores/create");
  }

  private void ViewStore(Guid id)
  {
    selectedStore = stores?.FirstOrDefault(s => s.Id == id);
    if (selectedStore == null)
      return;
    editableStore = new UpdateStoreRequest
    {
      Name = selectedStore?.Name,
      Location = selectedStore?.Location,
      LogoUrl = selectedStore?.LogoUrl
    };
    BuildStoreFields(editableStore);

    isEditMode = false;
    isModalOpen = true;
  }

  private void EditStore(Guid id)
  {
    selectedStore = stores?.FirstOrDefault(s => s.Id == id);
    if (selectedStore == null)
      return;
    editableStore = new UpdateStoreRequest
    {
      Name = selectedStore?.Name,
      Location = selectedStore?.Location,
      LogoUrl = selectedStore?.LogoUrl
    };
    BuildStoreFields(editableStore);

    isEditMode = true;
    isModalOpen = true;
  }

  private void BuildStoreFields(UpdateStoreRequest store)
  {
    storeFields = new()
{
new FieldDefinition<string?>
{
Label = "Store Name",
Type = "text",
Value = store.Name,
ValueChanged = EventCallback.Factory.Create<string?>(this, v => store.Name = v)
},
new FieldDefinition<string?>
{
Label = "Location",
Type = "text",
Value = store.Location,
ValueChanged = EventCallback.Factory.Create<string?>(this, v => store.Location = v)
},
new FieldDefinition<string?>
{
Label = "Logo URL",
Type = "text",
Value = store.LogoUrl,
ValueChanged = EventCallback.Factory.Create<string?>(this, v => store.LogoUrl = v)
}
};
  }

  private async Task SaveChanges()
  {
    if (selectedStore == null)
      return;

    var result = await StoreService.UpdateStore(selectedStore.Id, editableStore);

    if (result.Success)
    {
      await LoadStores();
      ToastService.ShowToast("Store updated successfully", string.Empty, ToastService.ToastLevel.Success);
    }
    else
    {
      ToastService.ShowToast("Failed to update store", string.Empty, ToastService.ToastLevel.Error);
    }

    CloseModal();
  }

  private void ConfirmDelete(Guid storeId)
  {
    var store = stores?.FirstOrDefault(s => s.Id == storeId);
    if (store == null)
      return;

    storeToDeleteId = store.Id;
    selectedStoreName = store.Name;
    isDeleteModalOpen = true;
  }

  private async Task DeleteStore()
  {
    var result = await StoreService.DeleteStore(storeToDeleteId);

    if (result.Success)
    {
      await LoadStores();
      ToastService.ShowToast("Store deleted successfully", string.Empty, ToastService.ToastLevel.Success);
    }
    else
    {
      ToastService.ShowToast("Failed to delete store", string.Empty, ToastService.ToastLevel.Error);
    }

    isDeleteModalOpen = false;
  }

  private void CloseModal()
  {
    isModalOpen = false;
    selectedStore = null;
  }
}