@page "/auth/login"
@layout PublicLayout
@using Microsoft.AspNetCore.WebUtilities
@using System.Text
@using System.Text.Json
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using System.Text.Json.Serialization
@using frontend.Services
@using MudBlazor
@using MudVariant = MudBlazor.Variant;
@inject NavigationManager Navigation
@inject CustomAuthStateProvider AuthProvider
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject ToastService ToastService

<MudThemeProvider Theme="_theme" />

<MudLayout>
    <!-- Top Nav -->
    <MudAppBar Elevation="2" Color="Color.Surface" Fixed="true">
        <MudText Typo="Typo.h5" Class="font-bold cursor-pointer mud-text-primary" Style="font-weight:800; cursor:pointer;"
                 @onclick='() => Navigation.NavigateTo("/")'>
            FastaBiz
        </MudText>
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center" Style="min-height:100vh; padding-top:80px; padding-bottom:40px;">
            <MudPaper Elevation="4" Class="pa-8 rounded-xl" Style="width:100%;">

                <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-6" Style="font-weight:700;">
                    Log in to FastaBiz
                </MudText>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
                }

                <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />

                    <!-- Email -->
                    <MudTextField @bind-Value="loginModel.Email"
                                  Label="Username or Email"
                                  Variant="MudVariant.Outlined"
                                  FullWidth="true"
                                  Class="mb-4"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Email"
                                  For="@(() => loginModel.Email)" />

                    <!-- Password -->
                    <MudTextField @bind-Value="loginModel.Password"
                                  Label="Password"
                                  Variant="MudVariant.Outlined"
                                  FullWidth="true"
                                  Class="mb-6"
                                  InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                  OnAdornmentClick="() => _showPassword = !_showPassword"
                                  AdornmentAriaLabel="Toggle password visibility"
                                  For="@(() => loginModel.Password)" />

                    <!-- Role Selection -->
                    <MudText Typo="Typo.subtitle2" Class="mb-3 mud-text-secondary" Align="Align.Center">
                        Select your role
                    </MudText>

                    <MudGrid Justify="Justify.Center" Class="mb-2">
                        @foreach (var role in _roles)
                        {
                            var isSelected = loginModel.Role == role.Key;
                            <MudItem xs="4">
                                <MudPaper @onclick="@(() => SelectRole(role.Key))"
                                          Elevation="@(isSelected ? 4 : 1)"
                                          Class="@($"d-flex flex-column align-center justify-center pa-3 rounded-lg cursor-pointer role-card {(isSelected ? "role-selected" : "")}")"
                                          Style="@($"border: 2px solid {(isSelected ? "var(--mud-palette-primary)" : "transparent")}; transition: all 0.2s; cursor:pointer;")">
                                    <MudText Style="font-size:2rem;">@role.Value.Icon</MudText>
                                    <MudText Typo="Typo.caption" Class="mt-1" Style="font-weight:600;">@role.Value.Label</MudText>
                                    @if (isSelected)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" Size="Size.Small" Class="mt-1" />
                                    }
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>

                    <ValidationMessage For="@(() => loginModel.Role)" class="mud-error-text d-flex justify-center mb-4" />

                    <!-- Submit -->
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="MudVariant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Size="Size.Large"
                               Class="mt-4"
                               Style="font-weight:700; border-radius:8px;">
                        Continue
                    </MudButton>
                </EditForm>

                <!-- Divider -->
                <MudDivider Class="my-5">
                    <MudChip T="string" Size="Size.Small" Variant="MudVariant.Text" Class="mud-text-secondary">or</MudChip>
                </MudDivider>

                <!-- Social Buttons -->
                <MudButton Variant="MudVariant.Filled"
                           FullWidth="true"
                           Class="mb-3"
                           Style="background:#4285F4; color:white; border-radius:8px; font-weight:600;">
                    <MudImage Src="https://www.svgrepo.com/show/475656/google-color.svg" Width="20" Height="20" Class="mr-2" />
                    Continue with Google
                </MudButton>

                <MudButton Variant="MudVariant.Outlined"
                    FullWidth="true"
                    Class="mb-4"
                    Style="border-radius:8px; font-weight:600;"
                    StartIcon="fab fa-apple">
                    Continue with Apple
                </MudButton>

                <!-- Links -->
                <MudText Align="Align.Center" Typo="Typo.body2" Class="mt-2">
                    Don't have a FastaBiz account?
                    <MudLink Href="/auth/register" Color="Color.Primary" Style="font-weight:600;">Sign Up</MudLink>
                </MudText>
                <MudText Align="Align.Center" Typo="Typo.body2" Class="mt-1">
                    Just browsing?
                    <MudLink Href="/" Color="Color.Primary" Style="font-weight:600;">Back to Home</MudLink>
                </MudText>

            </MudPaper>
        </MudContainer>
    </MudMainContent>

    <!-- Footer -->
    <MudAppBar Bottom="true" Fixed="true" Elevation="0" Color="Color.Dark" Dense="true">
        <MudText Typo="Typo.caption" Align="Align.Center" Style="width:100%; color:rgba(255,255,255,0.7);">
            Â© 2015â€“2025 FastaBiz Inc. â€¢
            <MudLink Href="#" Typo="Typo.caption" Style="color:rgba(255,255,255,0.9);">Privacy Policy</MudLink>
        </MudText>
    </MudAppBar>
</MudLayout>


@code {
    private string? returnUrl;
    private LoginModel loginModel = new();
    private string? errorMessage;
    private bool _showPassword = false;

    private MudTheme _theme = new MudTheme
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#16a34a",
            PrimaryContrastText = "#ffffff",
            AppbarBackground = "#ffffff",
            AppbarText = "#111827",
            Background = "#f9fafb",
            Surface = "#ffffff",
        }
    };

    private record RoleInfo(string Icon, string Label);
    private Dictionary<string, RoleInfo> _roles = new()
    {
        ["merchant"] = new("ðŸ§‘â€ðŸ’¼", "Merchant"),
        ["customer"] = new("ðŸ›’", "Customer"),
        ["driver"]   = new("ðŸšš", "Driver"),
    };

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        returnUrl = query["returnUrl"];
    }

    private void SelectRole(string role) => loginModel.Role = role;

    private async Task HandleLogin()
    {
        errorMessage = null;

        if (string.IsNullOrEmpty(loginModel.Role))
        {
            ToastService.ShowToast("Please select a role.", string.Empty, ToastService.ToastLevel.Warning);
            return;
        }

        try
        {
            var loginPayload = new { Email = loginModel.Email, Password = loginModel.Password };
            var content = new StringContent(
                JsonSerializer.Serialize(loginPayload),
                Encoding.UTF8, "application/json");

            var http = HttpClientFactory.CreateClient("AnonymousApi");
            var response = await http.PostAsync("public/login", content);
            var json = await response.Content.ReadAsStringAsync();

            loginModel.Password = string.Empty;

            if (response.IsSuccessStatusCode)
            {
                var tokenResponse = JsonSerializer.Deserialize<LoginTokenResponse>(json);
                if (tokenResponse is null || string.IsNullOrEmpty(tokenResponse.Token))
                {
                    ToastService.ShowToast("Token not received from server.", string.Empty, ToastService.ToastLevel.Error);
                    return;
                }

                var claimsUser = AuthProvider.ParseToken(tokenResponse.Token);
                if (claimsUser?.Role != loginModel.Role)
                {
                    ToastService.ShowToast($"User exists but is not assigned to role '{loginModel.Role}'", string.Empty, ToastService.ToastLevel.Error);
                    return;
                }

                await AuthProvider.SignInAsync(tokenResponse.Token);
                await JS.InvokeVoidAsync("localStorage.setItem", "showLoginSuccess", "true");
                var target = returnUrl ?? $"/{claimsUser.Role}/dashboard";
                Navigation.NavigateTo(target, forceLoad: true);
            }
            else
            {
                var errObj = JsonSerializer.Deserialize<ErrorResponse>(json);
                ToastService.ShowToast(errObj?.Error ?? "Unexpected error occurred.", string.Empty, ToastService.ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error connecting to server: {ex.Message}";
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Email or username is required")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please select a role")]
        public string Role { get; set; } = string.Empty;
    }

    private class ErrorResponse { public string? Error { get; set; } }

    private class LoginTokenResponse
    {
        [JsonPropertyName("id")]     public string ID       { get; set; } = string.Empty;
        [JsonPropertyName("fullName")] public string FullName { get; set; } = string.Empty;
        [JsonPropertyName("email")]  public string Email    { get; set; } = string.Empty;
        [JsonPropertyName("role")]   public string Role     { get; set; } = string.Empty;
        [JsonPropertyName("token")]  public string Token    { get; set; } = string.Empty;
    }
}
