@page "/auth/register-form"
@layout PublicLayout
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Microsoft.AspNetCore.WebUtilities
@using MudBlazor
@using MudVariant = MudBlazor.Variant
@inject AuthenticationStateProvider AuthProvider
@inject ToastService ToastService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory

<MudThemeProvider Theme="_theme" />

<MudLayout>
    <MudAppBar Elevation="2" Color="Color.Surface" Fixed="true">
        <MudText Typo="Typo.h5" Style="font-weight:800; cursor:pointer;" @onclick='() => Navigation.NavigateTo("/")'>
            FastaBiz
        </MudText>
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center" Style="min-height:100vh; padding-top:90px; padding-bottom:60px;">
            <MudPaper Elevation="4" Class="pa-8 rounded-xl" Style="width:100%;">

                <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-1" Style="font-weight:800;">Create your account</MudText>
                <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="mb-6 mud-text-secondary">
                    Signing up as <strong>@displayRole</strong>
                </MudText>

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">@successMessage</MudAlert>
                }
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
                }

                <!-- Social Buttons -->
                <MudButton Variant="MudVariant.Filled" FullWidth="true" Class="mb-3"
                           Style="background:#4285F4; color:white; border-radius:8px; font-weight:600;">
                    <MudImage Src="https://www.svgrepo.com/show/475656/google-color.svg" Width="20" Height="20" Class="mr-2" />
                    Continue with Google
                </MudButton>

                <MudButton Variant="MudVariant.Outlined"
                    FullWidth="true"
                    Class="mb-4"
                    Style="border-radius:8px; font-weight:600;"
                    StartIcon="fab fa-apple">
                    Continue with Apple
                </MudButton>

                <MudDivider Class="mb-5">
                    <MudChip T="string" Size="Size.Small" Variant="MudVariant.Text" Class="mud-text-secondary">or</MudChip>
                </MudDivider>

                <!-- Registration Form -->
                <EditForm Model="@registerModel" OnValidSubmit="@HandleValidSubmit">
                    <DataAnnotationsValidator />

                    <MudGrid Spacing="3">
                        <MudItem xs="6">
                            <MudTextField @bind-Value="registerModel.FullName"
                                          Label="Full Name"
                                          Variant="MudVariant.Outlined"
                                          FullWidth="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Person"
                                          For="@(() => registerModel.FullName)" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="registerModel.Phone"
                                          Label="Phone"
                                          Variant="MudVariant.Outlined"
                                          FullWidth="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Phone"
                                          For="@(() => registerModel.Phone)" />
                        </MudItem>
                    </MudGrid>

                    <MudTextField @bind-Value="registerModel.Email"
                                  Label="Email"
                                  Variant="MudVariant.Outlined"
                                  FullWidth="true"
                                  Class="mt-4"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Email"
                                  For="@(() => registerModel.Email)" />

                    <MudTextField @bind-Value="registerModel.Password"
                                  Label="Password (8+ characters)"
                                  Variant="MudVariant.Outlined"
                                  FullWidth="true"
                                  Class="mt-4"
                                  InputType="@(_showPass ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showPass ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                  OnAdornmentClick="() => _showPass = !_showPass"
                                  For="@(() => registerModel.Password)" />

                    <MudTextField @bind-Value="registerModel.ConfirmPassword"
                                  Label="Confirm Password"
                                  Variant="MudVariant.Outlined"
                                  FullWidth="true"
                                  Class="mt-4"
                                  InputType="@(_showConfirmPass ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showConfirmPass ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                  OnAdornmentClick="() => _showConfirmPass = !_showConfirmPass"
                                  For="@(() => registerModel.ConfirmPassword)" />

                    <!-- Checkboxes -->
                    <MudCheckBox T="bool" Checked="true" Disabled="true" Class="mt-3" Color="Color.Primary"
                                 Label="Send me helpful emails to find work and leads." />

                    <MudCheckBox T="bool" @bind-Checked="_agreedToTerms" Color="Color.Primary" Class="mt-1">
                        <span class="mud-body2">
                            I agree to the
                            <MudLink Href="#" Color="Color.Primary">Terms of Service</MudLink>
                            and
                            <MudLink Href="#" Color="Color.Primary">Privacy Policy</MudLink>.
                        </span>
                    </MudCheckBox>

                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="MudVariant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Size="Size.Large"
                               Disabled="@(!_agreedToTerms)"
                               Class="mt-6"
                               Style="font-weight:700; border-radius:8px;">
                        Create my account
                    </MudButton>
                </EditForm>

                <MudText Align="Align.Center" Typo="Typo.body2" Class="mt-5 mud-text-secondary">
                    Already have an account?
                    <MudLink Href="/auth/login" Color="Color.Primary" Style="font-weight:600;">Log In</MudLink>
                </MudText>

            </MudPaper>
        </MudContainer>
    </MudMainContent>

    <MudAppBar Bottom="true" Fixed="true" Elevation="0" Color="Color.Dark" Dense="true">
        <MudText Typo="Typo.caption" Style="width:100%; text-align:center; color:rgba(255,255,255,0.7);">
            © 2025 FastaBiz Inc. •
            <MudLink Href="#" Typo="Typo.caption" Style="color:rgba(255,255,255,0.9);">Privacy Policy</MudLink>
        </MudText>
    </MudAppBar>
</MudLayout>


@code {
    private RegisterModel registerModel = new();
    private string displayRole = string.Empty;
    private string? successMessage;
    private string? errorMessage;
    private bool _showPass = false;
    private bool _showConfirmPass = false;
    private bool _agreedToTerms = false;

    private MudTheme _theme = new MudTheme
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#16a34a",
            PrimaryContrastText = "#ffffff",
            AppbarBackground = "#ffffff",
            AppbarText = "#111827",
            Background = "#f9fafb",
            Surface = "#ffffff",
        }
    };

    private class ErrorResponse
    {
        public string? Error  { get; set; }
        public string? Detail { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            var role = state.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
            Navigation.NavigateTo($"/{role}/dashboard", forceLoad: true);
        }

        var uri = new Uri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        if (queryParams.TryGetValue("role", out var r))
        {
            registerModel.Role = r.ToString();
            displayRole = r.ToString() switch
            {
                "merchant" => "Business Owner",
                "customer" => "Customer",
                _ => r.ToString()
            };
        }
        else
        {
            displayRole = "User";
        }
    }

    private async Task HandleValidSubmit()
    {
        var http = HttpClientFactory.CreateClient("AnonymousApi");
        var response = await http.PostAsJsonAsync("public/create", registerModel);
        if (response.IsSuccessStatusCode)
        {
            ToastService.ShowToast("Account created successfully", "Redirecting to login…", ToastService.ToastLevel.Success);
            await Task.Delay(1500);
            registerModel = new RegisterModel();
            Navigation.NavigateTo("/auth/login", forceLoad: true);
            return;
        }
        await ShowErrorToast(response);
    }

    private async Task ShowErrorToast(HttpResponseMessage response)
    {
        try
        {
            var errorObj = await response.Content.ReadFromJsonAsync<ErrorResponse>();
            ToastService.ShowToast(errorObj?.Error ?? "Something went wrong", errorObj?.Detail ?? "Please try again later.", ToastService.ToastLevel.Error);
        }
        catch
        {
            ToastService.ShowToast("Unexpected error", "Please try again later.", ToastService.ToastLevel.Error);
        }
    }
}
